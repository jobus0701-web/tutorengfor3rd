<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡éŠæˆ²å¤§é›œç‡´ï¼šå®Œæ•´ç‰ˆ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        /* å®šç¾©å¯æ„›çš„å¡é€šå­—é«”ï¼Œä½¿ç”¨ Inter æ­é…åœ“è§’å’Œç²—é«”ç‡Ÿé€ ç«¥è¶£æ„Ÿ */
        .game-font {
            font-family: 'Inter', sans-serif;
        }

        /* æ¸¸æ¨™é–ƒçˆå‹•ç•« */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .cursor {
            animation: blink 1s step-end infinite;
        }

        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        .key-btn {
            height: 60px; /* Base height */
            transition: all 0.1s;
        }
        .shadow-cute {
            box-shadow: 0 4px 0 0 #D1A3A3;
        }
        .key-btn:active {
            box-shadow: 0 2px 0 0 #D1A3A3;
            transform: translateY(2px);
        }

        /* éŠæˆ²å¡ç‰‡æ¨£å¼ - ç´”å¹³é¢ï¼Œç„¡ç¿»è½‰ */
        .match-card-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            border-radius: 1rem;
            border: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        .matched-success {
            background-color: #90EE90 !important; /* Light Green */
            border-color: #3CB371 !important; /* Medium Sea Green */
            color: #1E40AF !important;
            cursor: default;
        }

        /* Bingo ç›¸é—œæ¨£å¼ */
        .bingo-grid {
            display: grid;
            gap: 4px;
            aspect-ratio: 1 / 1;
        }
        .bingo-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 4px;
            text-align: center;
            background-color: #FFEC99; /* Accent Yellow */
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #FFD700;
            transition: all 0.2s;
            height: 100%;
            text-transform: lowercase; /* ç¢ºä¿å¡ç‰‡ä¸Šçš„æ–‡å­—é¡¯ç¤ºç‚ºå°å¯« */
        }
        .bingo-cell.marked {
            background-color: #90EE90; /* Success Green */
            border-color: #3CB371;
            color: white;
            transform: scale(0.95);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }

        @media (min-width: 768px) {
            .bingo-cell {
                font-size: 0.9rem;
            }
        }
        /* ä¿®æ­£ Game 4 å¡«å­—éŠæˆ² CSS æ®˜ç•™ */
        .crossword-grid, .crossword-cell { display: none; }
    </style>

    <script>
        // è¨­å®š Tailwind é…ç½®, ä½¿ç”¨æŸ”å’Œå¯æ„›çš„é¦¬å¡é¾é…è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#FFC7C7',      // ä¸»é¡Œç²‰ (æŸ”å’Œå¯æ„›)
                        'secondary-blue': '#BDE0FE',    // è¼”åŠ©è—
                        'accent-yellow': '#FFEC99',     // å¼·èª¿é»ƒ
                        'background-light': '#F8F8F8',  // æ·ºèƒŒæ™¯
                        'keyboard-bg': '#FFF5D6',       // éµç›¤å€å¡ŠèƒŒæ™¯
                    },
                    boxShadow: {
                        'cute': '0 4px 0 0 #D1A3A3',    // æŒ‰éˆ•ç«‹é«”é™°å½±
                        'key-active': '0 2px 0 0 #D1A3A3', // æŒ‰ä¸‹æ™‚çš„é™°å½±
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background-light min-h-screen game-font flex flex-col items-center p-4">

    <!-- è¨Šæ¯æç¤ºæ¡† -->
    <div id="message-box" class="fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 hidden">
        <p id="message-content"></p>
    </div>

    <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡å°èˆª -->
    <header class="w-full max-w-4xl text-center mb-4 p-4 bg-primary-pink rounded-2xl shadow-lg border-b-4 border-pink-400">
        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-wider">
            <!-- å¯æ„›å°è±¬åœ–ç¤º (SVG) -->
            <svg class="h-10 w-10 md:h-12 md:w-12 inline-block mr-3 transform -translate-y-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM15 9C15.8284 9 16.5 8.32843 16.5 = 7.5C16.5 6.67157 15.8284 6 15 6C14.1716 6 13.5 6.67157 13.5 7.5C13.5 8.32843 14.1716 9 15 9ZM9 9C9.82843 9 10.5 8.32843 10.5 7.5C10.5 6.67157 9.82843 6 9 6C8.17157 6 7.5 6.67157 7.5 7.5C7.5 8.32843 8.17157 9 9 9Z" fill="#FF8FAB"/>
                <path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" fill="#F0B5C2"/>
                <circle cx="11" cy="13" r="1" fill="#FF8FAB"/>
                <circle cx="13" cy="13" r="1" fill="#FF8FAB"/>
            </svg>
            è‹±æ–‡éŠæ¨‚åœ’
        </h1>
    </header>

    <!-- å°èˆªåˆ— -->
    <nav class="w-full max-w-4xl mb-6">
        <div class="flex flex-wrap justify-center space-x-2 md:space-x-4">
            <!-- Tab æŒ‰éˆ•ä½¿ç”¨äº‹ä»¶å§”è¨— (Event Delegation) è™•ç† -->
            <button data-game="game1" id="tab-game1" onclick="changeGame('game1')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ğŸ“ æ‹¼éŸ³ç™½æ¿
            </button>
            <button data-game="game2" id="tab-game2" onclick="changeGame('game2')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ğŸ§© å­—æ¯å°å°ç¢°
            </button>
            <button data-game="game3" id="tab-game3" onclick="changeGame('game3')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ğŸ–ï¸ çŒœå–®å­—
            </button>
            <button data-game="game4" id="tab-game4" onclick="changeGame('game4')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ğŸ° é›™äººè³“æœ
            </button>
            <button data-game="game5" id="tab-game5" onclick="changeGame('game5')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ğŸ‘‚ å­—æ¯æ’åº
            </button>
            <!-- é‡æ–°åŠ å…¥å–®å­—å¾Œå° Tab -->
            <button data-game="admin" id="tab-admin" onclick="changeGame('admin')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                âš™ï¸ å–®å­—å¾Œå°
            </button>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ -->
    <main id="game-content" class="w-full max-w-4xl bg-white p-4 md:p-8 rounded-2xl shadow-xl border-4 border-secondary-blue flex flex-col space-y-6 min-h-[500px]">
        <!-- å…§å®¹ç”± JS æ¸²æŸ“ -->
        <div class="flex justify-center items-center h-full">
            <p class="text-xl text-gray-500">æ­£åœ¨è¼‰å…¥æ‡‰ç”¨ç¨‹å¼...</p>
        </div>
    </main>

    <!-- å…¨åŸŸç‹€æ…‹èˆ‡è¨­å®š -->
    <script>
        // ç§»é™¤æ‰€æœ‰ Firebase ç›¸é—œçš„å…¨åŸŸè®Šæ•¸å’Œå°å…¥

        // ä¿®æ­£: å°‡ ALPHABET è½‰æ›ç‚ºå°å¯«
        const ALPHABET = 'abcdefghijklmnopqrstuvwxyz'.split(''); 
        const LOCAL_STORAGE_KEY = 'G3_CustomWords'; // localStorage key for persistent storage
        
        // çŒœå–®å­—éŠæˆ²çš„å…§å»ºå–®å­—åº« (ç”¨æ–¼å–ä»£ Firestore)
        // å…§éƒ¨ä»ä½¿ç”¨å¤§å¯«ï¼Œä½†åœ¨å¾Œå°è¼¸å…¥å’ŒéŠæˆ²é¡¯ç¤ºæ™‚æœƒè¢«èª¿æ•´
        const GAME3_DICTIONARY = [
            "APPLE", "BANANA", "CAT", "DOG", "ELEPHANT", "GIRAFFE", "MONKEY", 
            "SUN", "RAIN", "CLOUD", "HAPPY", "SMILE", "BOOK", "PENCIL", "SCHOOL"
        ].map(word => word.toUpperCase());
        
        const G2_COLOR_PALETTE = [
            { bg: 'bg-yellow-200', border: 'border-yellow-400', text: 'text-yellow-800' }, 
            { bg: 'bg-green-200', border: 'border-green-400', text: 'text-green-800' },   
            { bg: 'bg-purple-200', border: 'border-purple-400', text: 'text-purple-800' }, 
            { bg: 'bg-red-200', border: 'border-red-400', text: 'text-red-800' },       
            { bg: 'bg-cyan-200', border: 'border-cyan-400', text: 'text-cyan-800' },     
            { bg: 'bg-pink-200', border: 'border-pink-400', text: 'text-pink-800' }      
        ];

        // éŠæˆ² 4 (BINGO) å–®å­—åº«
        const BINGO_DICTIONARY = [
            "SIX", "SEVEN", "EIGHT", "NINE", "TEN", "HOW OLD", "ARE", "YOU", "I", "AM", "YEARS OLD", 
            "ONE", "TWO", "THREE", "FOUR", "FIVE", "ANGRY", "HAPPY", "SAD", "HUNGRY", "THIRSTY", 
            "YES", "NO", "NOT", "BALL", "CAR", "DOLL", "KITE", "ROBOT", "YO-YO", "WHAT", "THIS", 
            "THAT", "IT", "IS", "A", "BLUE", "GREEN", "PINK", "PURPLE", "RED", "YELLOW", "COLOR"
        ].map(word => word.toUpperCase());
        const BINGO_SIZE = 4; // 4x4

        let currentGame = 'game1';
        
        // å„²å­˜å¾ localStorage è¼‰å…¥çš„è‡ªè¨‚å–®å­—
        let localWordList = []; 

        let state = {
            // Game 1
            g1_currentWord: [],   
            g1_cursorIndex: 0, 
            
            // Game 2
            g2_matchCards: [],
            g2_flippedCards: [],
            g2_matchCount: 0,
            g2_letters: ['A', 'B', 'C', 'D'], // ä»ä½¿ç”¨å¤§å¯«ä½œç‚ºé…å°åŸºåº•

            // Game 3
            g3_currentGuessWord: '',
            g3_guessedLetters: new Set(),
            g3_wrongGuesses: 0,
            g3_gameStatus: 'ready',
            g3_MAX_WRONG: 6,

            // Game 4 (Bingo)
            g4_players: [
                { id: 1, name: 'ç©å®¶ 1', card: [], marked: new Set(), winner: false, score: 0 },
                { id: 2, name: 'ç©å®¶ 2', card: [], marked: new Set(), winner: false, score: 0 },
            ],
            g4_calledWords: new Set(),
            g4_lastCalledWord: '',
            g4_gameStatus: 'ready', // ready, calling, finished
            g4_isCalling: false,
            
            // Game 5
            g5_letters: [],               
            g5_answer: [],                
            g5_currentSort: [],           
        };


        // --- TTS ç›¸é—œå·¥å…·å‡½å¼ (ä½¿ç”¨ç€è¦½å™¨ SpeechSynthesis) ---
        async function callTTS(text) {
            if (!('speechSynthesis' in window)) {
                MessageBox.show("ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³æ’­æ”¾åŠŸèƒ½ã€‚", true);
                return;
            }
            
            // èªéŸ³æ’­å ±ä»ä½¿ç”¨å¤§å¯«å–®å­—ï¼Œé€™æ¨£ç™¼éŸ³æœƒæ›´æ¸…æ™°è‡ªç„¶ã€‚
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 
            utterance.rate = 0.9;
            
            await new Promise(resolve => {
                utterance.onend = resolve;
                utterance.onerror = (e) => {
                    console.error("SpeechSynthesis error:", e);
                    MessageBox.show("èªéŸ³æ’­æ”¾å¤±æ•—ã€‚", true);
                    resolve();
                };
                window.speechSynthesis.speak(utterance);
            });
        }


        // éŒ¯èª¤è™•ç†æ¨¡çµ„
        const MessageBox = {
            show: (message, isError = true) => {
                const box = document.getElementById('message-box');
                const content = document.getElementById('message-content');
                
                content.textContent = message;
                box.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
                box.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

                setTimeout(() => box.classList.add('hidden'), 3000);
            }
        };

        // --- LocalStorage å­˜å„²åŠŸèƒ½ ---

        function loadWordsFromLocal() {
            try {
                const stored = localStorage.getItem(LOCAL_STORAGE_KEY);
                localWordList = stored ? JSON.parse(stored) : [];
                if (!Array.isArray(localWordList)) localWordList = []; // æ•¸æ“šæ ¼å¼æª¢æŸ¥
            } catch (e) {
                console.error("Error loading words from local storage:", e);
                localWordList = [];
            }
        }

        function saveWordsToLocal() {
            try {
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(localWordList));
            } catch (e) {
                console.error("Error saving words to local storage:", e);
                MessageBox.show("ç„¡æ³•ä¿å­˜å–®å­—åˆ°æ‚¨çš„ç€è¦½å™¨ã€‚", true);
            }
        }


        // --- æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼æ§åˆ¶ ---
        function setTabActive(gameName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
                btn.classList.add('bg-white', 'text-gray-700', 'shadow-md');
            });

            const activeTab = document.getElementById(`tab-${gameName}`);
            if (activeTab) {
                activeTab.classList.remove('bg-white', 'text-gray-700', 'shadow-md');
                activeTab.classList.add('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
            }
        }

        function changeGame(gameName) {
            currentGame = gameName;
            setTabActive(gameName);
            renderApp();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderApp() {
            // åœ¨æ¯æ¬¡æ¸²æŸ“å‰å…ˆè¼‰å…¥æœ¬åœ°å„²å­˜çš„å–®å­—
            loadWordsFromLocal(); 

            switch (currentGame) {
                case 'game1':
                    renderGame1();
                    break;
                case 'game2':
                    initGame2();
                    break;
                case 'game3':
                    state.g3_gameStatus = 'ready';
                    initGame3();
                    break;
                case 'game4':
                    initGame4(); // Bingo
                    break;
                case 'game5':
                    initGame5();
                    break;
                case 'admin': // è™•ç† Admin é é¢
                    renderWordAdmin();
                    break;
            }
        }

        window.onload = function() {
            setTabActive(currentGame);
            renderApp();
        }
    </script>


    <script>
        // --- éŠæˆ² 1 (æ‹¼éŸ³ç™½æ¿) é‚è¼¯ ---
        function renderGame1() {
            const html = `
                <section class="w-full bg-secondary-blue p-2 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ“ å­—æ¯ç™½æ¿æ‹¼éŸ³å·¥å…· (Phonics Whiteboard)</h2>
                    <!-- ç™½æ¿é¡¯ç¤ºå€ -->
                    <div id="whiteboard-display" 
                         class="whiteboard-display min-h-[100px] w-full bg-white rounded-lg p-3 md:p-6 overflow-x-auto whitespace-nowrap text-left 
                                text-3xl md:text-5xl font-extrabold text-gray-800 border-2 border-gray-300">
                        <!-- å…§å®¹ç”± JS æ¸²æŸ“ -->
                    </div>
                    <p class="text-xs md:text-sm text-blue-900 mt-2 text-center">ğŸ’¡ é»é¸ç™½æ¿ä¸Šçš„å­—æ¯å³å¯åˆªé™¤ï¼Œæ¸¸æ¨™æœƒè‡ªå‹•ç§»å›è©²è™•ã€‚</p>
                </section>

                <section class="w-full bg-keyboard-bg p-4 rounded-xl shadow-lg border-b-8 border-accent-yellow">
                    
                    <!-- å­—æ¯éµç›¤ (A-Z) -->
                    <div id="keyboard-alphabet" class="grid grid-cols-7 md:grid-cols-10 gap-2 mb-4">
                        ${ALPHABET.map(letter => `
                            <button onclick="insertLetterG1('${letter}')" 
                                    class="key-btn bg-white hover:bg-secondary-blue active:shadow-key-active shadow-cute text-2xl md:text-4xl font-extrabold text-gray-800 rounded-xl transition duration-150">
                                ${letter}
                            </button>
                        `).join('')}
                    </div>

                    <!-- ç‰¹æ®ŠåŠŸèƒ½éµ -->
                    <div class="grid grid-cols-4 gap-2">
                        <!-- å·¦ç§»éµ -->
                        <button onclick="moveCursorG1('left')" 
                                class="key-btn bg-accent-yellow hover:bg-yellow-400 active:shadow-key-active shadow-cute text-xl md:text-3xl font-bold text-yellow-900 rounded-xl">
                            <span aria-label="å·¦ç§»">&leftarrow;</span>
                        </button>
                        <!-- åˆªé™¤éµ -->
                        <button onclick="deleteLeftG1()" 
                                class="key-btn bg-red-400 hover:bg-red-500 active:shadow-key-active shadow-cute text-xl md:text-2xl font-bold text-white rounded-xl">
                            åˆªé™¤
                        </button>
                        <!-- ç©ºç™½éµ (ä½”å…©æ ¼) -->
                        <button onclick="insertSpaceG1()" 
                                class="key-btn col-span-2 bg-green-400 hover:bg-green-500 active:shadow-key-active shadow-cute text-lg md:text-2xl font-bold text-white rounded-xl">
                            ç©ºç™½éµ
                        </button>
                        <!-- å³ç§»éµ -->
                        <button onclick="moveCursorG1('right')" 
                                class="key-btn bg-accent-yellow hover:bg-yellow-400 active:shadow-key-active shadow-cute text-xl md:text-3xl font-bold text-yellow-900 rounded-xl">
                            <span aria-label="å³ç§»">&rightarrow;</span>
                        </button>
                    </div>
                </section>
            `;
            document.getElementById('game-content').innerHTML = html;
            renderWhiteboardG1(); 
        }

        function renderWhiteboardG1() {
            const whiteboard = document.getElementById('whiteboard-display');
            if (!whiteboard) return;
            whiteboard.innerHTML = '';
            
            const displayArray = [...state.g1_currentWord];
            const cursorElement = `<span id="cursor-element" class="cursor text-3xl md:text-5xl font-extrabold text-gray-800 select-none">|</span>`;
            displayArray.splice(state.g1_cursorIndex, 0, cursorElement);

            let htmlContent = '';
            
            displayArray.forEach((item, index) => {
                if (item.includes('cursor-element')) {
                    htmlContent += item; 
                } else {
                    const originalIndex = index < state.g1_cursorIndex ? index : index - 1;

                    if (item === ' ') {
                        htmlContent += `<span class="inline-block mx-2 text-3xl md:text-5xl font-extrabold text-gray-400 select-none">_</span>`;
                    } else {
                        htmlContent += `<span onclick="deleteClickedLetterG1(${originalIndex})" 
                                             class="whiteboard-letter transition-colors duration-150 p-1 rounded-md hover:bg-red-200 cursor-pointer 
                                                    text-3xl md:text-5xl font-extrabold text-gray-800 lowercase">
                                           ${item}
                                       </span>`;
                    }
                }
            });
            whiteboard.innerHTML = htmlContent;
            whiteboard.scrollLeft = whiteboard.scrollWidth;
        }

        function insertLetterG1(char) {
            if (state.g1_currentWord.length >= 40) return; 
            // ä¿®æ­£: æ’å…¥å°å¯«å­—æ¯
            state.g1_currentWord.splice(state.g1_cursorIndex, 0, char.toLowerCase());
            state.g1_cursorIndex++;
            renderWhiteboardG1();
        }

        function deleteClickedLetterG1(indexToDelete) {
            if (indexToDelete >= 0 && indexToDelete < state.g1_currentWord.length) {
                state.g1_currentWord.splice(indexToDelete, 1);
                state.g1_cursorIndex = indexToDelete; 
                renderWhiteboardG1();
            }
        }

        function deleteLeftG1() {
            if (state.g1_cursorIndex > 0) {
                state.g1_currentWord.splice(state.g1_cursorIndex - 1, 1);
                state.g1_cursorIndex--;
                renderWhiteboardG1();
            }
        }

        function insertSpaceG1() {
            insertLetterG1(' ');
        }

        function moveCursorG1(direction) {
            if (direction === 'left' && state.g1_cursorIndex > 0) {
                state.g1_cursorIndex--;
            } else if (direction === 'right' && state.g1_cursorIndex < state.g1_currentWord.length) {
                state.g1_cursorIndex++;
            }
            renderWhiteboardG1();
        }
        // --- éŠæˆ² 1 (æ‹¼éŸ³ç™½æ¿) é‚è¼¯çµæŸ ---


        // --- éŠæˆ² 2 (å­—æ¯å°å°ç¢°) é‚è¼¯ ---
        function initGame2() {
            state.g2_matchCount = 0;
            state.g2_flippedCards = [];
            
            let cardValues = [];
            
            state.g2_letters.forEach((l, index) => {
                const color = G2_COLOR_PALETTE[index % G2_COLOR_PALETTE.length];
                const lower = l.toLowerCase();
                const upper = l.toUpperCase();
                
                const groupId = `match-${lower}`; 

                cardValues.push({ id: crypto.randomUUID(), value: upper, groupId, color, matched: false, flipped: false });
                cardValues.push({ id: crypto.randomUUID(), value: lower, groupId, color, matched: false, flipped: false });
            });
            
            for (let i = cardValues.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardValues[i], cardValues[j]] = [cardValues[j], cardValues[i]];
            }
            state.g2_matchCards = cardValues;
            renderGame2();
        }

        function handleCardClickG2(id) {
            const cardIndex = state.g2_matchCards.findIndex(c => c.id === id);
            const card = state.g2_matchCards[cardIndex];

            if (!card) return;
            if (card.matched || card.flipped || state.g2_flippedCards.length === 2) {
                return;
            }

            card.flipped = true;
            state.g2_flippedCards.push(card);
            renderGame2(); 

            if (state.g2_flippedCards.length === 2) {
                const [card1, card2] = state.g2_flippedCards;
                
                if (card1.groupId === card2.groupId) {
                    card1.matched = true;
                    card2.matched = true;
                    state.g2_matchCount++;
                    
                    state.g2_flippedCards = []; 
                    renderGame2(); 
                    
                    if (state.g2_matchCount === state.g2_letters.length) {
                        setTimeout(() => MessageBox.show("å¤ªæ£’äº†ï¼æ‰€æœ‰é…å°æˆåŠŸï¼ğŸ‰", false), 500);
                    }
                } else {
                    setTimeout(() => {
                        const index1 = state.g2_matchCards.findIndex(c => c.id === card1.id);
                        const index2 = state.g2_matchCards.findIndex(c => c.id === card2.id);
                        
                        if (index1 !== -1) state.g2_matchCards[index1].flipped = false;
                        if (index2 !== -1) state.g2_matchCards[index2].flipped = false;
                        
                        state.g2_flippedCards = [];
                        renderGame2(); 
                    }, 1000);
                }
            }
        }

        function renderGame2() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game2') return;

            const cardsHtml = state.g2_matchCards.map(card => {
                const color = card.color;
                
                let cardClasses = `h-24 md:h-32 match-card-item shadow-xl hover:shadow-2xl`;
                let content = '';
                let innerTextClass = `text-4xl md:text-5xl font-extrabold`;

                if (card.matched) {
                    cardClasses += ` matched-success ${card.matched ? '' : 'cursor-default'}`; 
                    content = card.value;
                    innerTextClass += ` text-white`;
                } else if (card.flipped) {
                    cardClasses += ` ${color.bg} ${color.border}`;
                    content = card.value;
                    innerTextClass += ` ${color.text}`;
                } else {
                    cardClasses += ` bg-secondary-blue border-blue-600`;
                    content = '?';
                    innerTextClass += ` text-blue-900`;
                }

                return `
                    <div class="h-24 md:h-32 rounded-xl" onclick="handleCardClickG2('${card.id}')">
                        <div class="${cardClasses}">
                            <span class="${innerTextClass}">
                                ${content}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-4 text-center">ğŸ§© å­—æ¯å°å°ç¢° (Letter Match-Up)</h2>
                    <p class="text-center text-sm mb-4">ç›®æ¨™: é»æ“Šå¡ç‰‡ï¼Œé…å°å¤§å°å¯«å­—æ¯ã€‚</p>
                    <div id="match-game-grid" class="grid grid-cols-4 gap-3 md:gap-4 max-w-lg mx-auto">
                        ${cardsHtml}
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="initGame2()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ${state.g2_matchCount === state.g2_letters.length ? 'å†ç©ä¸€æ¬¡' : 'é‡æ–°é–‹å§‹'}
                        </button>
                    </div>
                </section>
            `;
        }
        // --- éŠæˆ² 2 (å­—æ¯å°å°ç¢°) é‚è¼¯çµæŸ ---


        // --- éŠæˆ² 3 (Hangman) é‚è¼¯ ---
        
        // Hangman ç¹ªåœ– SVG åŠ©æ‰‹å‡½æ•¸
        function getHangmanSVG(wrongGuesses, status) {
            const parts = [];
            const color = status === 'won' ? '#3CB371' : (status === 'lost' ? '#FF4500' : '#4A5568'); 
            const strokeStyle = `stroke="${color}" stroke-width="6" stroke-linecap="round"`;
            
            // Base Gallows (Gallows, Crossbar, Rope - 3 parts)
            parts.push(`<line x1="50" y1="200" x2="150" y2="200" stroke="${color}" stroke-width="6"/>`); 
            parts.push(`<line x1="100" y1="200" x2="100" y2="20" stroke="${color}" stroke-width="6"/>`); 
            parts.push(`<line x1="100" y1="20" x2="160" y2="20" stroke="${color}" stroke-width="6"/>`); 
            parts.push(`<line x1="160" y1="20" x2="160" y2="40" stroke="${color}" stroke-width="3"/>`); 

            // Character Drawing (6 parts for the body)
            
            // 1. Head
            if (wrongGuesses >= 1) {
                parts.push(`<circle cx="160" cy="60" r="20" stroke="${color}" stroke-width="3" fill="none"/>`);
            }

            // 2. Body
            if (wrongGuesses >= 2) {
                parts.push(`<line x1="160" y1="80" x2="160" y2="140" ${strokeStyle}/>`);
            }

            // 3. Left Arm
            if (wrongGuesses >= 3) {
                parts.push(`<line x1="160" y1="90" x2="140" y2="110" ${strokeStyle}/>`);
            }

            // 4. Right Arm
            if (wrongGuesses >= 4) {
                parts.push(`<line x1="160" y1="90" x2="180" y2="110" ${strokeStyle}/>`);
            }

            // 5. Left Leg
            if (wrongGuesses >= 5) {
                parts.push(`<line x1="160" y1="140" x2="140" y2="160" ${strokeStyle}/>`);
            }

            // 6. Right Leg (Game Over)
            if (wrongGuesses >= 6) {
                parts.push(`<line x1="160" y1="140" x2="180" y2="160" ${strokeStyle}/>`);
            }
            
            // Add expressions for Game Over
            if (status === 'lost') {
                // X eyes and Sad Mouth
                parts.push(`<line x1="150" y1="50" x2="155" y2="55" stroke="#FF4500" stroke-width="2"/>`);
                parts.push(`<line x1="155" y1="50" x2="150" y2="55" stroke="#FF4500" stroke-width="2"/>`);
                parts.push(`<line x1="165" y1="50" x2="170" y2="55" stroke="#FF4500" stroke-width="2"/>`);
                parts.push(`<line x1="170" y1="50" x2="165" y2="55" stroke="#FF4500" stroke-width="2"/>`);
                parts.push(`<path d="M150 70 Q160 80 170 70" fill="none" stroke="#FF4500" stroke-width="3"/>`);
            } else if (status === 'won') {
                // Happy face
                parts.push(`<circle cx="155" cy="50" r="2" fill="#3CB371"/>`);
                parts.push(`<circle cx="165" cy="50" r="2" fill="#3CB371"/>`);
                parts.push(`<path d="M155 70 Q160 60 165 70" fill="none" stroke="#3CB371" stroke-width="3"/>`);
            }


            return `<svg width="200" height="220" viewBox="0 0 200 220" xmlns="http://www.w3.org/2000/svg">
                        ${parts.join('')}
                    </svg>`;
        }


        async function initGame3() {
            // æ±ºå®šå–®å­—åº«ï¼šå¦‚æœ localWordList æœ‰å–®å­—ï¼Œå°±ä½¿ç”¨æœ¬åœ°çš„ï¼›å¦å‰‡ä½¿ç”¨å…§å»ºçš„ã€‚
            const sourceDictionary = localWordList.length > 0 ? localWordList.map(item => item.word) : GAME3_DICTIONARY;

            if (sourceDictionary.length === 0) {
                state.g3_gameStatus = 'no_words';
                renderGame3();
                MessageBox.show("çŒœå–®å­—éŠæˆ²ç›®å‰æ²’æœ‰å–®å­—ï¼è«‹è‡³å¾Œå°æ–°å¢ã€‚", true);
                return;
            }
            
            const randomWord = sourceDictionary[Math.floor(Math.random() * sourceDictionary.length)];
            state.g3_currentGuessWord = randomWord.toUpperCase(); // å…§éƒ¨é‚è¼¯ä»ä½¿ç”¨å¤§å¯«
            state.g3_guessedLetters = new Set();
            state.g3_wrongGuesses = 0;
            state.g3_gameStatus = 'playing';
            
            renderGame3(); 
        }

        function guessLetterG3(letter) {
            // å…§éƒ¨é‚è¼¯ä½¿ç”¨å¤§å¯«é€²è¡Œåˆ¤æ–·
            const upperCaseLetter = letter.toUpperCase();
            
            if (state.g3_gameStatus !== 'playing' || state.g3_guessedLetters.has(upperCaseLetter)) return;
            
            state.g3_guessedLetters.add(upperCaseLetter);
            
            if (!state.g3_currentGuessWord.includes(upperCaseLetter)) {
                state.g3_wrongGuesses++;
            }
            checkWinConditionG3();
            renderGame3();
        }

        function checkWinConditionG3() {
            const hiddenWord = state.g3_currentGuessWord.split('').filter(char => char !== ' ');
            const guessedCorrectly = hiddenWord.every(char => state.g3_guessedLetters.has(char));

            if (guessedCorrectly) {
                state.g3_gameStatus = 'won';
                MessageBox.show(`æ­å–œæ‚¨ï¼ŒçŒœå°äº†ï¼ğŸ‰ å–®å­—æ˜¯ ${state.g3_currentGuessWord}ï¼`, false);
            } else if (state.g3_wrongGuesses >= state.g3_MAX_WRONG) {
                state.g3_gameStatus = 'lost';
                MessageBox.show(`å¾ˆå¯æƒœï¼Œå¤±æ•—äº†ã€‚ğŸ˜­ æ­£ç¢ºå–®å­—æ˜¯ ${state.g3_currentGuessWord}ã€‚`, true);
            }
        }

        function renderGame3() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game3') return;
            
            if (state.g3_gameStatus === 'no_words') {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">éŠæˆ²ç„¡æ³•é–‹å§‹ï¼Œè«‹æª¢æŸ¥å…§å»ºå–®å­—åº«ã€‚</p>`;
                return;
            }

            const displayWord = state.g3_currentGuessWord.split('').map(char => {
                if (char === ' ') return '&nbsp;&nbsp;'; 
                const isGameOver = state.g3_gameStatus === 'won' || state.g3_gameStatus === 'lost';
                if (state.g3_guessedLetters.has(char) || isGameOver) {
                    return char.toLowerCase(); // ä¿®æ­£: é¡¯ç¤ºå°å¯«
                }
                return '_';
            }).join(' ');

            const alphabetBtns = ALPHABET.map(letter => {
                const upperCaseLetter = letter.toUpperCase();
                let btnClass = 'bg-white hover:bg-secondary-blue';
                let onClick = `guessLetterG3('${letter}')`;

                if (state.g3_guessedLetters.has(upperCaseLetter)) {
                    btnClass = state.g3_currentGuessWord.includes(upperCaseLetter) ? 'bg-green-400 cursor-not-allowed' : 'bg-red-400 cursor-not-allowed';
                    onClick = '';
                }

                if (state.g3_gameStatus !== 'playing') {
                    btnClass = 'bg-gray-300 cursor-not-allowed';
                    onClick = '';
                }

                return `
                    <button onclick="${onClick}" 
                            class="key-btn ${btnClass} active:shadow-key-active shadow-cute text-xl md:text-3xl font-extrabold rounded-xl transition duration-150 text-gray-800">
                        ${letter} <!-- ä¿®æ­£: é¡¯ç¤ºå°å¯« -->
                    </button>
                `;
            }).join('');

            const errorIndicator = `<div class="flex justify-center space-x-2 mt-2">
                ${Array(state.g3_MAX_WRONG).fill(0).map((_, i) => `
                    <div class="w-6 h-6 rounded-full ${i < state.g3_wrongGuesses ? 'bg-red-600 shadow-lg' : 'bg-gray-300'}"></div>
                `).join('')}
                <p class="text-sm text-gray-600 ml-3">éŒ¯èª¤æ¬¡æ•¸: ${state.g3_wrongGuesses}/${state.g3_MAX_WRONG}</p>
            </div>`;

            // Hangman ç¹ªåœ–å€
            const hangmanDrawing = getHangmanSVG(state.g3_wrongGuesses, state.g3_gameStatus);
            
            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ–ï¸ å¯æ„› Hangman çŒœå–®å­— (Hangman Word Guess)</h2>
                </section>
                
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- å·¦å´: Hangman ç¹ªåœ–èˆ‡éŒ¯èª¤æŒ‡ç¤º -->
                    <div class="flex-1 p-4 bg-white rounded-xl shadow-md border-2 border-gray-200 flex flex-col items-center">
                        <p class="text-lg font-semibold text-center mb-2 text-blue-800">ğŸ’” éŒ¯èª¤æ¬¡æ•¸: ${state.g3_wrongGuesses}/${state.g3_MAX_WRONG}</p>
                        <div class="w-full max-w-sm h-[250px] flex items-center justify-center mx-auto p-4">
                            ${hangmanDrawing}
                        </div>
                        ${errorIndicator}
                    </div>

                    <!-- å³å´: çŒœæ¸¬å€ -->
                    <div class="flex-1 p-4 bg-keyboard-bg rounded-xl shadow-md border-2 border-gray-200">
                        <p class="text-lg font-semibold text-center mb-4 text-blue-800">çŒœæ¸¬å–®å­—:</p>
                        <div class="text-center text-4xl md:text-6xl font-extrabold tracking-widest mb-6 p-2 bg-white rounded-lg border-b-4 border-gray-300 whitespace-nowrap overflow-x-auto">
                            ${displayWord}
                        </div>
                        
                        <div class="grid grid-cols-7 gap-1 md:gap-2">
                            ${alphabetBtns}
                        </div>
                        
                        <div class="text-center mt-6">
                            <button onclick="initGame3()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                                ${state.g3_gameStatus === 'playing' ? 'é‡è¨­éŠæˆ²' : 'é–‹å§‹æ–°éŠæˆ²'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        // --- éŠæˆ² 3 (Hangman) é‚è¼¯çµæŸ ---


        // --- éŠæˆ² 4 (é›™äººè‹±æ–‡è³“æœ) é‚è¼¯ ---
        function shuffleArray(array) {
            let temp = [...array];
            for (let i = temp.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [temp[i], temp[j]] = [temp[j], temp[i]];
            }
            return temp;
        }

        function generateBingoCard() {
            const requiredSize = BINGO_SIZE * BINGO_SIZE; // 4x4 = 16
            if (BINGO_DICTIONARY.length < requiredSize) {
                MessageBox.show(`è³“æœå–®å­—åº«ä¸è¶³ ${requiredSize} å€‹ï¼Œè«‹æª¢æŸ¥å…§å»ºå–®å­—åº«ã€‚`, true);
                return Array(requiredSize).fill('ERROR');
            }
            // ç”±æ–¼è³“æœéŠæˆ²å–®å­—åº«è¼ƒå°ï¼Œæˆ‘å€‘éœ€è¦ç¢ºä¿æ¯å€‹ç©å®¶çš„å¡ç‰‡å–®å­—ä¸é‡è¤‡
            const usedWords = new Set();
            let card = [];
            
            // ç¢ºä¿å¾ BINGO_DICTIONARY è¤‡è£½ä¸€ä»½å–®å­—æ± 
            let availablePool = shuffleArray(BINGO_DICTIONARY); 
            
            // å¦‚æœå–®å­—åº«ä¸å¤  32 å€‹ (2 * 16)ï¼Œå¯èƒ½æœƒé‡è¤‡ï¼Œä½†é€™æ˜¯å”¯ä¸€çš„éœæ…‹è§£æ±ºæ–¹æ¡ˆ
            
            for (let i = 0; i < requiredSize; i++) {
                // é€™è£¡æˆ‘å€‘ä¸å¼·åˆ¶å–®å­—ä¸é‡è¤‡ï¼Œå› ç‚ºå–®å­—åº«å¯èƒ½ä¸è¶³ 32 å€‹
                card.push(availablePool.pop()); 
            }

            return card;
        }

        function checkWinG4(player) {
            let lines = 0;
            const size = BINGO_SIZE; // size = 4
            const card = player.card;
            const marked = player.marked;

            // æª¢æŸ¥æ‰€æœ‰è¡Œå’Œåˆ—
            for (let i = 0; i < size; i++) {
                let rowCount = 0;
                let colCount = 0;
                for (let j = 0; j < size; j++) {
                    // Row check (0,1,2,3), (4,5,6,7), ...
                    if (marked.has(card[i * size + j])) rowCount++;
                    // Col check (0,4,8,12), (1,5,9,13), ...
                    if (marked.has(card[j * size + i])) colCount++;
                }
                if (rowCount === size) lines++;
                if (colCount === size) lines++;
            }

            // æª¢æŸ¥å°è§’ç·š (ä¸»å°è§’ç·š)
            let diag1Count = 0;
            for (let i = 0; i < size; i++) {
                if (marked.has(card[i * size + i])) diag1Count++;
            }
            if (diag1Count === size) lines++;

            // æª¢æŸ¥åå°è§’ç·š
            let diag2Count = 0;
            for (let i = 0; i < size; i++) {
                // Indices: (3), (6), (9), (12) for 4x4
                if (marked.has(card[i * size + (size - 1 - i)])) diag2Count++;
            }
            if (diag2Count === size) lines++;
            
            player.score = lines;
            return lines >= 2; // ç²å‹æ¢ä»¶: é€£å…©æ¢ç·š
        }

        function initGame4() {
            // Bingo åˆå§‹åŒ–
            state.g4_players[0].card = generateBingoCard();
            state.g4_players[0].marked = new Set();
            state.g4_players[0].winner = false;
            state.g4_players[0].score = 0;

            state.g4_players[1].card = generateBingoCard();
            state.g4_players[1].marked = new Set();
            state.g4_players[1].winner = false;
            state.g4_players[1].score = 0;

            state.g4_calledWords = new Set();
            state.g4_lastCalledWord = '';
            state.g4_gameStatus = 'ready'; // ready -> calling -> finished
            state.g4_isCalling = false;
            
            renderGame4();
        }

        async function startCallingG4() {
            if (state.g4_gameStatus === 'finished') {
                initGame4(); // é‡æ–°é–‹å§‹
                return;
            }
            
            if (state.g4_isCalling) return;
            
            const availableWords = shuffleArray(BINGO_DICTIONARY.filter(w => !state.g4_calledWords.has(w)));
            
            if (availableWords.length === 0) {
                 MessageBox.show("å–®å­—åº«å·²æŠ½å®Œï¼", true);
                 return;
            }
            
            const nextWord = availableWords[0];
            state.g4_lastCalledWord = nextWord; // å„²å­˜å¤§å¯«å–®å­— (å…§éƒ¨é‚è¼¯)
            state.g4_calledWords.add(nextWord);
            
            // 1. è¨­å®š 'æ’­å ±ä¸­' ç‹€æ…‹ä¸¦ç«‹å³æ¸²æŸ“ UI (ç¢ºä¿æŒ‰éˆ•ç‹€æ…‹åˆ‡æ›)
            state.g4_isCalling = true;
            state.g4_gameStatus = 'calling';
            renderGame4(); 
            
            // 2. èªéŸ³æ’­å ± (ä½¿ç”¨ç€è¦½å™¨ TTS - æ’­å ±å¤§å¯«å–®å­—ä»¥ç¢ºä¿ç™¼éŸ³æ¸…æ™°)
            await callTTS(nextWord); 
            
            // 3. èªéŸ³çµæŸå¾Œï¼Œé‡è¨­ç‹€æ…‹
            state.g4_isCalling = false; 

            // 4. æª¢æŸ¥æ˜¯å¦æœ‰è´å®¶
            let winnerFound = false;
            state.g4_players.forEach(player => {
                if (checkWinG4(player)) {
                    player.winner = true;
                    winnerFound = true;
                }
            });

            if (winnerFound) {
                state.g4_gameStatus = 'finished';
                renderGame4();
                MessageBox.show(`è³“æœï¼ç©å®¶ ${state.g4_players.filter(p => p.winner).map(p => p.id).join(' å’Œ ')} ç²å‹ï¼`, false);
            } else {
                renderGame4(); // ç¢ºä¿ UI æ›´æ–°ä»¥ç§»é™¤ 'æ’­å ±ä¸­...' ç‹€æ…‹
            }
        }

        function handleCardClickG4(playerId, index) {
            const player = state.g4_players.find(p => p.id === playerId);
            if (!player || state.g4_gameStatus !== 'calling' || player.winner) return;

            const word = player.card[index]; // å¤§å¯«å–®å­—

            if (state.g4_calledWords.has(word)) {
                if (player.marked.has(word)) {
                    player.marked.delete(word); // å–æ¶ˆæ¨™è¨˜ (å¯é¸)
                } else {
                    player.marked.add(word); // æ¨™è¨˜
                }

                // æª¢æŸ¥æ˜¯å¦ç²å‹
                if (checkWinG4(player)) {
                    player.winner = true;
                    state.g4_gameStatus = 'finished';
                    MessageBox.show(`è³“æœï¼ç©å®¶ ${playerId} ç²å‹ï¼`, false);
                }
                renderGame4();
            } else {
                MessageBox.show(`å–®å­— ${word.toLowerCase()} å°šæœªè¢«å”¸å‡ºï¼`, true);
            }
        }

        function renderGame4() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game4') return;
            
            const renderCard = (player) => {
                const cellsHtml = player.card.map((word, index) => {
                    const isMarked = player.marked.has(word);
                    return `
                        <div class="bingo-cell ${isMarked ? 'marked' : 'hover:bg-yellow-300'}" 
                             onclick="handleCardClickG4(${player.id}, ${index})">
                            ${word.toLowerCase()} <!-- ä¿®æ­£: é¡¯ç¤ºå°å¯« -->
                        </div>
                    `;
                }).join('');

                return `
                    <div class="flex-1 min-w-0 p-3 rounded-xl shadow-lg border-4 ${player.winner ? 'border-green-600 bg-green-100' : 'border-secondary-blue bg-white'}">
                        <h3 class="text-xl font-bold text-center mb-3 ${player.winner ? 'text-green-700' : 'text-blue-800'}">
                            ${player.name} ${player.winner ? 'ğŸ‰ WINNER ğŸ‰' : ''} (ç·šæ•¸: ${player.score})
                        </h3>
                        <!-- 4x4 ç¶²æ ¼ -->
                        <div class="bingo-grid mx-auto" style="grid-template-columns: repeat(${BINGO_SIZE}, 1fr); grid-template-rows: repeat(${BINGO_SIZE}, 1fr);">
                            ${cellsHtml}
                        </div>
                    </div>
                `;
            };

            const controlArea = `
                <div class="text-center p-4 bg-keyboard-bg rounded-xl shadow-lg border-b-8 border-accent-yellow mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">
                        ${state.g4_gameStatus === 'ready' ? 'æº–å‚™é–‹å§‹' : state.g4_gameStatus === 'calling' ? 'éŠæˆ²ä¸­' : 'éŠæˆ²çµæŸ'}
                    </h3>
                    
                    <div class="mb-4 h-12 flex items-center justify-center">
                        <!-- çªå‡ºé¡¯ç¤ºæœ€æ–°æŠ½å–çš„å–®å­— -->
                        <p class="text-4xl font-black text-red-700 transition duration-300">
                            <!-- ä¿®æ­£: é¡¯ç¤ºå°å¯« -->
                            ${state.g4_lastCalledWord ? `å–®å­—: ${state.g4_lastCalledWord.toLowerCase()}` : state.g4_gameStatus === 'ready' ? 'é»æ“Šé–‹å§‹æŒ‰éˆ•' : 'ç­‰å¾…ä¸‹ä¸€è¼ª...'}
                        </p>
                    </div>

                    <button onclick="startCallingG4()" 
                            class="bg-primary-pink hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl transition duration-200 
                                ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'disabled' : ''}>
                        ${state.g4_gameStatus === 'ready' ? 'ğŸ”Š é–‹å§‹éŠæˆ² / æŠ½å–å–®å­—' : state.g4_gameStatus === 'calling' ? (state.g4_isCalling ? 'ğŸ™ï¸ æ’­å ±ä¸­...' : 'ğŸ”Š æŠ½å–ä¸‹ä¸€å€‹å–®å­—') : 'ğŸ”„ é‡æ–°é–‹å§‹'}
                    </button>
                    <p class="text-xs text-gray-600 mt-2">å·²æŠ½å‡º ${state.g4_calledWords.size} å€‹å–®å­— / å‰©é¤˜ ${BINGO_DICTIONARY.length - state.g4_calledWords.size} å€‹</p>
                </div>
            `;

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-4 text-center">ğŸ° é›™äººè‹±æ–‡è³“æœ (Two-Player Bingo)</h2>
                    <p class="text-center text-sm text-blue-900 mb-6">ç›®æ¨™: é»æ“Šä¸­å¤®æŒ‰éˆ•è½å–å–®å­—ï¼Œä¸¦åœ¨æ‚¨çš„ 4x4 è³“æœå¡ä¸Šæ¨™è¨˜ã€‚æœ€å…ˆå®Œæˆå…©æ¢ç·šï¼ˆæ°´å¹³ã€å‚ç›´æˆ–å°è§’ç·šï¼‰è€…ç²å‹ï¼</p>
                    
                    <!-- æ’å…¥æ§åˆ¶å€å¡Š (æ”¾åœ¨å¡ç‰‡ä¸Šæ–¹) -->
                    ${controlArea}
                    
                    <!-- è³“æœå¡ä¸¦æ’é¡¯ç¤º (ä½¿ç”¨ flex-col md:flex-row å¯¦ç¾å®Œå…¨éŸ¿æ‡‰) -->
                    <div class="flex flex-col md:flex-row gap-6">
                        ${renderCard(state.g4_players[0])}
                        ${renderCard(state.g4_players[1])}
                    </div>
                    
                </section>
            `;
        }
        // --- éŠæˆ² 4 (é›™äººè‹±æ–‡è³“æœ) é‚è¼¯çµæŸ ---


        // --- éŠæˆ² 5: å­—æ¯é †åºæ’åº (Letter Order Sort) é‚è¼¯ ---
        
        // æ–°å¢è¼”åŠ©å‡½æ•¸ï¼šæ ¹æ“šç­–ç•¥ç”Ÿæˆå¤§å°å¯«å­—æ¯
        function getRandomCaseLetterG5(letter, strategy) {
            if (strategy === 'UPPER') return letter.toUpperCase();
            if (strategy === 'LOWER') return letter.toLowerCase();
            
            // MIXED strategy
            return Math.random() < 0.5 ? letter.toUpperCase() : letter.toLowerCase();
        }

        function initGame5() {
            const totalLetters = 4;
            
            // 1. éš¨æ©Ÿé¸æ“‡å¤§å°å¯«ç­–ç•¥ (0: Upper, 1: Lower, 2: Mixed)
            const strategyIndex = Math.floor(Math.random() * 3);
            const strategies = ['UPPER', 'LOWER', 'MIXED'];
            const currentStrategy = strategies[strategyIndex];

            // 2. é¸å– 4 å€‹ä¸é‡è¤‡çš„å­—æ¯åŸºåº• (å¤§å¯«)
            let baseRandomLetters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').sort(() => 0.5 - Math.random()).slice(0, totalLetters);
            
            // 3. æ‡‰ç”¨å¤§å°å¯«ç­–ç•¥
            let generatedLetters = baseRandomLetters.map(l => getRandomCaseLetterG5(l, currentStrategy));

            // 4. å»ºç«‹ state.g5_letters (äº‚åºï¼Œå¸¶æœ‰å¤§å°å¯«)
            state.g5_letters = generatedLetters.map(l => ({ id: crypto.randomUUID(), value: l, isDropped: false }));
            state.g5_letters = shuffleArray(state.g5_letters); 

            // 5. å»ºç«‹ state.g5_answer (æ ¹æ“šå­—æ¯è¡¨é †åºæ’åºï¼Œä¿ç•™åŸå§‹å¤§å°å¯«)
            state.g5_answer = [...generatedLetters].sort((a, b) => a.localeCompare(b, 'en', { sensitivity: 'base' })); 

            state.g5_currentSort = Array(totalLetters).fill(null); 

            renderGame5();
        }
        
        function speakLettersG5() {
            if (!('speechSynthesis' in window)) {
                MessageBox.show("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³æ’­æ”¾åŠŸèƒ½ã€‚", true);
                return;
            }
            
            // å”¸å‡ºæ­£ç¢ºçš„å­—æ¯é †åº (state.g5_answer)ï¼Œå› ç‚ºæ˜¯ sorted ä¸”å¸¶æœ‰å¤§å°å¯«
            const lettersToSpeak = state.g5_answer.join(', '); 
            
            const speakSequence = (count) => {
                if (count >= 3) return;
                
                const utterance = new SpeechSynthesisUtterance(lettersToSpeak);
                utterance.lang = 'en-US'; 
                utterance.rate = 0.8; 
                
                utterance.onend = () => {
                    setTimeout(() => speakSequence(count + 1), 500); 
                };
                window.speechSynthesis.speak(utterance);
            };

            speakSequence(0);
        }

        function handleLetterClickG5(id) {
            const letter = state.g5_letters.find(l => l.id === id);
            if (!letter || letter.isDropped) return;

            const targetIndex = state.g5_currentSort.findIndex(item => item === null);

            if (targetIndex !== -1) {
                state.g5_currentSort[targetIndex] = letter.value; // å„²å­˜å¤§å°å¯«å­—æ¯
                letter.isDropped = true; 
                renderGame5();
                checkCompletionG5();
            }
        }
        
        function handleResetTargetG5(index) {
            const char = state.g5_currentSort[index];
            if (!char) return;

            // æ ¹æ“šå€¼æŸ¥æ‰¾å°æ‡‰çš„å­—æ¯ç‰©ä»¶
            const letter = state.g5_letters.find(l => l.value === char);
            if (letter) {
                letter.isDropped = false;
            }
            
            state.g5_currentSort[index] = null;
            renderGame5();
        }

        function checkCompletionG5() {
            if (state.g5_currentSort.some(item => item === null)) return;
            
            // æ¯”è¼ƒæ™‚å¿…é ˆä½¿ç”¨ case-sensitive é‚è¼¯ï¼Œå› ç‚ºç­”æ¡ˆæ˜¯åŒ…å«å¤§å°å¯«çš„
            const currentWord = state.g5_currentSort.join('');
            const answerWord = state.g5_answer.join('');
            
            // ä½¿ç”¨ localeCompare é€²è¡Œå¤§å°å¯«æ•æ„Ÿçš„ç²¾ç¢ºæ¯”è¼ƒ
            const isCorrect = currentWord.localeCompare(answerWord, 'en', { sensitivity: 'case' }) === 0;

            if (isCorrect) {
                MessageBox.show("æ­å–œï¼å­—æ¯é †åºå®Œå…¨æ­£ç¢ºï¼ğŸ‰", false);
            } else {
                const targetBoxes = document.querySelectorAll('.target-box');
                targetBoxes.forEach(box => {
                    box.classList.add('bg-red-300');
                    setTimeout(() => box.classList.remove('bg-red-300'), 500);
                });
                MessageBox.show("é †åºä¸æ­£ç¢ºï¼Œå†è©¦è©¦çœ‹ï¼", true);
            }
        }

        function renderGame5() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game5') return;

            const targetBoxesHtml = state.g5_currentSort.map((char, index) => `
                <div class="w-16 h-16 bg-white target-box border-4 border-dashed border-gray-400 rounded-lg flex items-center justify-center text-3xl font-bold cursor-pointer hover:bg-gray-100 transition duration-150"
                     onclick="handleResetTargetG5(${index})">
                    ${char || ' '}
                </div>
            `).join('');

            const letterBlocksHtml = state.g5_letters.map(letter => `
                <button onclick="handleLetterClickG5('${letter.id}')"
                        class="w-16 h-16 bg-accent-yellow ${letter.isDropped ? 'opacity-30 cursor-default' : 'hover:bg-yellow-400 shadow-cute'} rounded-lg flex items-center justify-center text-3xl font-bold transition duration-200"
                        ${letter.isDropped ? 'disabled' : ''}>
                    ${letter.value}
                </button>
            `).join('');


            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-4 text-center">ğŸ‘‚ å­—æ¯é †åºæ’åº (Letter Order Sort)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: å°‡è½åˆ°çš„å­—æ¯æŒ‰å­—æ¯è¡¨é †åºæ’åˆ—ã€‚</p>
                    
                    <div class="text-center mb-6">
                        <button onclick="speakLettersG5()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl flex items-center mx-auto">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a.75.75 0 011.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 011.06-1.06L12 12.44L15.536 8.464z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21a9 9 0 100-18 9 9 0 000 18z"></path></svg>
                            é»æ“Šå”¸å‡ºå­—æ¯ (é‡è¤‡ 3 æ¬¡)
                        </button>
                    </div>
                    
                    <div class="flex justify-center space-x-3 mb-8 p-4 bg-white rounded-xl shadow-inner border-4 border-gray-300">
                        ${targetBoxesHtml}
                    </div>

                    <div class="flex justify-center space-x-3 p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow">
                        ${letterBlocksHtml}
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="initGame5()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            é‡æ–°é–‹å§‹éŠæˆ²
                        </button>
                    </div>
                </section>
            `;
        }


        // --- å–®å­—ç®¡ç†å¾Œå° é‚è¼¯ ---
        
        function addWord() {
            const input = document.getElementById('new-word-input');
            const word = input.value.trim().toUpperCase();

            if (!word || !/^[A-Z\s]+$/.test(word)) { 
                MessageBox.show("è«‹è¼¸å…¥æœ‰æ•ˆçš„è‹±æ–‡å­—æ¯å–®å­—æˆ–è©çµ„ã€‚");
                return;
            }

            // æª¢æŸ¥æ˜¯å¦é‡è¤‡
            const exists = localWordList.some(item => item.word.toUpperCase() === word);
            if (exists) {
                MessageBox.show(`å–®å­— ${word} å·²ç¶“å­˜åœ¨æ–¼åˆ—è¡¨ä¸­ã€‚`);
                input.value = '';
                return;
            }
            
            // æ–°å¢å–®å­— (ä½¿ç”¨ UUID ä½œç‚º ID)
            localWordList.push({ id: crypto.randomUUID(), word: word });
            saveWordsToLocal();
            input.value = '';
            MessageBox.show(`å–®å­— ${word} æ–°å¢æˆåŠŸï¼(å·²å„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨)`, false);

            renderWordAdmin();
        }

        function deleteWord(id) {
            const initialLength = localWordList.length;
            // éæ¿¾æ‰è¦åˆªé™¤çš„å–®å­—
            localWordList = localWordList.filter(item => item.id !== id);

            if (localWordList.length < initialLength) {
                saveWordsToLocal();
                MessageBox.show("å–®å­—åˆªé™¤æˆåŠŸï¼", false);
            } else {
                 MessageBox.show("å–®å­—åˆªé™¤å¤±æ•—ï¼Œæ‰¾ä¸åˆ°è©² IDã€‚", true);
            }
            
            renderWordAdmin();
        }

        function renderWordAdmin() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'admin') return;
            
            // ç”±æ–¼æ¯æ¬¡ renderApp éƒ½æœƒ loadWordsFromLocalï¼Œé€™è£¡ç›´æ¥ä½¿ç”¨ localWordList
            const wordListHtml = localWordList.map((item, index) => `
                <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm mb-2 border-l-4 border-primary-pink">
                    <span class="text-lg font-bold text-gray-800">${index + 1}. ${item.word}</span>
                    <button onclick="deleteWord('${item.id}')" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full bg-red-100 transition duration-150">
                        ğŸ—‘ï¸ åˆªé™¤
                    </button>
                </li>
            `).join('');

            container.innerHTML = `
                <section class="w-full bg-primary-pink p-4 rounded-xl shadow-inner border-b-8 border-pink-600">
                    <h2 class="text-xl md:text-3xl font-bold text-white mb-2 text-center">âš™ï¸ å–®å­—ç®¡ç†å¾Œå° (Local Storage Admin Panel)</h2>
                    <p class="text-center text-pink-100">ğŸ’¡ é€™è£¡çš„å–®å­—åƒ…å„²å­˜åœ¨æ‚¨ç•¶å‰çš„ç€è¦½å™¨ä¸­ï¼Œä¸¦ä¾›ã€ŒçŒœå–®å­—ã€éŠæˆ²ä½¿ç”¨ã€‚</p>
                </section>

                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md">
                    <label for="new-word-input" class="block text-lg font-semibold text-gray-800 mb-2">æ–°å¢å–®å­—/è©çµ„</label>
                    <div class="flex space-x-2">
                        <input type="text" id="new-word-input" placeholder="ä¾‹å¦‚ï¼šPIG" maxlength="20"
                               class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                        <button onclick="addWord()" class="bg-secondary-blue hover:bg-blue-400 text-blue-900 font-bold py-3 px-6 rounded-lg shadow-cute transition duration-150">
                            â• æ–°å¢
                        </button>
                    </div>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-md border-2 border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ç›®å‰è‡ªè¨‚å–®å­—åˆ—è¡¨ (${localWordList.length} å€‹)</h3>
                    <ul class="max-h-80 overflow-y-auto">
                        ${localWordList.length > 0 ? wordListHtml : '<p class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰å–®å­—ã€‚è«‹æ–°å¢ï¼</p>'}
                    </ul>
                    ${localWordList.length > 0 ? '<p class="text-xs text-gray-400 mt-4 text-center">æ‚¨çš„å–®å­—å·²è‡ªå‹•å„²å­˜ã€‚</p>' : ''}
                </div>
            `;
        }
    </script>
</body>
</html>
