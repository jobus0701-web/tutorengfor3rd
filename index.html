<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‹±æ–‡éŠæˆ²å¤§é›œç‡´ï¼šå®Œæ•´ç‰ˆ</title>
    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase JS æ¨¡çµ„ -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, getDocs, deleteDoc, where, updateDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // è¨­å®š Firebase å…¨åŸŸè®Šæ•¸
        window.firebaseImports = { 
            initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, 
            getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, getDocs, deleteDoc, where, updateDoc, setLogLevel
        };
    </script>

    <style>
        /* å®šç¾©å¯æ„›çš„å¡é€šå­—é«”ï¼Œä½¿ç”¨ Inter æ­é…åœ“è§’å’Œç²—é«”ç‡Ÿé€ ç«¥è¶£æ„Ÿ */
        .game-font {
            font-family: 'Inter', sans-serif;
        }

        /* æ¸¸æ¨™é–ƒçˆå‹•ç•« */
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0; }
        }
        .cursor {
            animation: blink 1s step-end infinite;
        }

        /* æŒ‰éˆ•åŸºç¤æ¨£å¼ */
        .key-btn {
            height: 60px; /* Base height */
            transition: all 0.1s;
        }
        .shadow-cute {
            box-shadow: 0 4px 0 0 #D1A3A3;
        }
        .key-btn:active {
            box-shadow: 0 2px 0 0 #D1A3A3;
            transform: translateY(2px);
        }

        /* éŠæˆ²å¡ç‰‡æ¨£å¼ - ç´”å¹³é¢ï¼Œç„¡ç¿»è½‰ */
        .match-card-item {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            width: 100%;
            border-radius: 1rem;
            border: 4px solid;
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        .matched-success {
            background-color: #90EE90 !important; /* Light Green */
            border-color: #3CB371 !important; /* Medium Sea Green */
            color: #1E40AF !important;
            cursor: default;
        }

        /* Bingo ç›¸é—œæ¨£å¼ */
        /* ç§»é™¤å›ºå®šçš„ 5x5 CSSï¼Œæ”¹ç”¨ inline style å¯¦ç¾ 4x4 */
        .bingo-grid {
            display: grid;
            gap: 4px;
            aspect-ratio: 1 / 1;
        }
        .bingo-cell {
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            padding: 4px;
            text-align: center;
            background-color: #FFEC99; /* Accent Yellow */
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid #FFD700;
            transition: all 0.2s;
            height: 100%;
        }
        .bingo-cell.marked {
            background-color: #90EE90; /* Success Green */
            border-color: #3CB371;
            color: white;
            transform: scale(0.95);
            box-shadow: inset 0 0 5px rgba(0,0,0,0.3);
        }

        @media (min-width: 768px) {
            .bingo-cell {
                font-size: 0.9rem;
            }
        }
        /* ä¿®æ­£ Game 4 å¡«å­—éŠæˆ² CSS æ®˜ç•™ */
        .crossword-grid, .crossword-cell { display: none; }
    </style>

    <script>
        // è¨­å®š Tailwind é…ç½®ï¼Œä½¿ç”¨æŸ”å’Œå¯æ„›çš„é¦¬å¡é¾é…è‰²
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'primary-pink': '#FFC7C7',      // ä¸»é¡Œç²‰ (æŸ”å’Œå¯æ„›)
                        'secondary-blue': '#BDE0FE',    // è¼”åŠ©è—
                        'accent-yellow': '#FFEC99',     // å¼·èª¿é»ƒ
                        'background-light': '#F8F8F8',  // æ·ºèƒŒæ™¯
                        'keyboard-bg': '#FFF5D6',       // éµç›¤å€å¡ŠèƒŒæ™¯
                    },
                    boxShadow: {
                        'cute': '0 4px 0 0 #D1A3A3',    // æŒ‰éˆ•ç«‹é«”é™°å½±
                        'key-active': '0 2px 0 0 #D1A3A3', // æŒ‰ä¸‹æ™‚çš„é™°å½±
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-background-light min-h-screen game-font flex flex-col items-center p-4">

    <!-- è¨Šæ¯æç¤ºæ¡† -->
    <div id="message-box" class="fixed top-4 right-4 bg-red-500 text-white p-3 rounded-lg shadow-xl z-50 transition-opacity duration-300 hidden">
        <p id="message-content"></p>
    </div>

    <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡å°èˆª -->
    <header class="w-full max-w-4xl text-center mb-4 p-4 bg-primary-pink rounded-2xl shadow-lg border-b-4 border-pink-400">
        <h1 class="text-3xl md:text-5xl font-extrabold text-white tracking-wider">
            <!-- å¯æ„›å°è±¬åœ–ç¤º (SVG) -->
            <svg class="h-10 w-10 md:h-12 md:w-12 inline-block mr-3 transform -translate-y-1" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path fill-rule="evenodd" clip-rule="evenodd" d="M12 2C6.48 2 2 6.48 2 12C2 17.52 6.48 22 12 22C17.52 22 22 17.52 22 12C22 6.48 17.52 2 12 2ZM15 9C15.8284 9 16.5 8.32843 16.5 7.5C16.5 6.67157 15.8284 6 15 6C14.1716 6 13.5 6.67157 13.5 7.5C13.5 8.32843 14.1716 9 15 9ZM9 9C9.82843 9 10.5 8.32843 10.5 7.5C10.5 6.67157 9.82843 6 9 6C8.17157 6 7.5 6.67157 7.5 7.5C7.5 8.32843 8.17157 9 9 9Z" fill="#FF8FAB"/>
                <path d="M12 17C14.2091 17 16 15.2091 16 13C16 10.7909 14.2091 9 12 9C9.79086 9 8 10.7909 8 13C8 15.2091 9.79086 17 12 17Z" fill="#F0B5C2"/>
                <circle cx="11" cy="13" r="1" fill="#FF8FAB"/>
                <circle cx="13" cy="13" r="1" fill="#FF8FAB"/>
            </svg>
            è‹±æ–‡éŠæ¨‚åœ’
        </h1>
        <p id="user-id-display" class="text-xs text-pink-700 mt-1 break-words">ç”¨æˆ¶ID: è¼‰å…¥ä¸­...</p>
    </header>

    <!-- å°èˆªåˆ— -->
    <nav class="w-full max-w-4xl mb-6">
        <div class="flex flex-wrap justify-center space-x-2 md:space-x-4">
            <!-- Tab æŒ‰éˆ•ä½¿ç”¨äº‹ä»¶å§”è¨— (Event Delegation) è™•ç† -->
            <button data-game="game1" id="tab-game1" onclick="changeGame('game1')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ğŸ“ æ‹¼éŸ³ç™½æ¿
            </button>
            <button data-game="game2" id="tab-game2" onclick="changeGame('game2')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ğŸ§© å­—æ¯å°å°ç¢°
            </button>
            <button data-game="game3" id="tab-game3" onclick="changeGame('game3')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ğŸ–ï¸ çŒœå–®å­—
            </button>
            <button data-game="game4" id="tab-game4" onclick="changeGame('game4')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ğŸ° é›™äººè³“æœ
            </button>
            <button data-game="game5" id="tab-game5" onclick="changeGame('game5')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                ğŸ‘‚ å­—æ¯æ’åº
            </button>
            <button data-game="admin" id="tab-admin" onclick="changeGame('admin')" class="tab-btn bg-white py-2 px-3 md:px-6 rounded-full text-sm md:text-lg font-bold text-gray-700 transition duration-300 shadow-md">
                âš™ï¸ å–®å­—å¾Œå°
            </button>
        </div>
    </nav>

    <!-- ä¸»å…§å®¹å€ -->
    <main id="game-content" class="w-full max-w-4xl bg-white p-4 md:p-8 rounded-2xl shadow-xl border-4 border-secondary-blue flex flex-col space-y-6 min-h-[500px]">
        <!-- å…§å®¹ç”± JS æ¸²æŸ“ -->
    </main>

    <!-- å…¨åŸŸç‹€æ…‹èˆ‡è¨­å®š -->
    <script>
        // Firestore Data Management & Auth Setup
        let db, auth;
        let userId = '';
        let isAuthReady = false;
        let currentGame = 'game1';
        let wordList = []; // å„²å­˜å¾ Firestore è®€å–çš„å–®å­—

        // å…¨åŸŸè®Šæ•¸æª¢æŸ¥èˆ‡åˆå§‹åŒ– (ä¾†è‡ª Immersive Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const FIREBASE_COLLECTION = 'word_guess_words'; // ç”¨æ–¼å–®å­—å¾Œå°

        const ALPHABET = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');
        const G2_COLOR_PALETTE = [
            { bg: 'bg-yellow-200', border: 'border-yellow-400', text: 'text-yellow-800' }, 
            { bg: 'bg-green-200', border: 'border-green-400', text: 'text-green-800' },   
            { bg: 'bg-purple-200', border: 'border-purple-400', text: 'text-purple-800' }, 
            { bg: 'bg-red-200', border: 'border-red-400', text: 'text-red-800' },       
            { bg: 'bg-cyan-200', border: 'border-cyan-400', text: 'text-cyan-800' },     
            { bg: 'bg-pink-200', border: 'border-pink-400', text: 'text-pink-800' }      
        ];

        // éŠæˆ² 4 (BINGO) å–®å­—åº« - ä¾†è‡ªä½¿ç”¨è€…æä¾›
        const BINGO_DICTIONARY = [
            "SIX", "SEVEN", "EIGHT", "NINE", "TEN", "HOW OLD", "ARE", "YOU", "I", "AM", "YEARS OLD", 
            "ONE", "TWO", "THREE", "FOUR", "FIVE", "ANGRY", "HAPPY", "SAD", "HUNGRY", "THIRSTY", 
            "YES", "NO", "NOT", "BALL", "CAR", "DOLL", "KITE", "ROBOT", "YO-YO", "WHAT", "THIS", 
            "THAT", "IT", "IS", "A", "BLUE", "GREEN", "PINK", "PURPLE", "RED", "YELLOW", "COLOR"
        ].map(word => word.toUpperCase());
        const BINGO_SIZE = 4; // ä¿®æ­£: è³“æœå¡å¤§å°æ”¹ç‚º 4x4

        let state = {
            // Game 1
            g1_currentWord: [],   
            g1_cursorIndex: 0, 
            
            // Game 2
            g2_matchCards: [],
            g2_flippedCards: [],
            g2_matchCount: 0,
            g2_letters: ['A', 'B', 'C', 'D'], // ä¿®æ­£: 4 å­—æ¯ (8 å¼µå¡ç‰‡)

            // Game 3
            g3_currentGuessWord: '',
            g3_guessedLetters: new Set(),
            g3_wrongGuesses: 0,
            g3_gameStatus: 'ready',
            g3_imageUrl: '',
            g3_MAX_WRONG: 6,

            // Game 4 (Bingo)
            g4_players: [
                { id: 1, name: 'ç©å®¶ 1', card: [], marked: new Set(), winner: false, score: 0 },
                { id: 2, name: 'ç©å®¶ 2', card: [], marked: new Set(), winner: false, score: 0 },
            ],
            g4_calledWords: new Set(),
            g4_lastCalledWord: '',
            g4_gameStatus: 'ready', // ready, calling, finished
            g4_isCalling: false,
            
            // Game 5
            g5_letters: [],               
            g5_answer: [],                
            g5_currentSort: [],           
        };


        // --- TTS ç›¸é—œå·¥å…·å‡½å¼ (TTS API: gemini-2.5-flash-preview-tts) ---
        function base64ToArrayBuffer(base64) {
            const binaryString = atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcm16, sampleRate) {
            const numChannels = 1;
            const bitsPerSample = 16;
            const blockAlign = numChannels * (bitsPerSample / 8);
            const byteRate = sampleRate * blockAlign;
            const dataSize = pcm16.length * 2;
            const buffer = new ArrayBuffer(44 + dataSize);
            const view = new DataView(buffer);
            let offset = 0;

            function writeString(str) {
                for (let i = 0; i < str.length; i++) {
                    view.setUint8(offset + i, str.charCodeAt(i));
                }
                offset += str.length;
            }

            // RIFF chunk
            writeString('RIFF');
            view.setUint32(offset, 36 + dataSize, true); offset += 4;
            writeString('WAVE');

            // fmt chunk
            writeString('fmt ');
            view.setUint32(offset, 16, true); offset += 4;       // Subchunk1Size (16 for PCM)
            view.setUint16(offset, 1, true); offset += 2;        // AudioFormat (1 for PCM)
            view.setUint16(offset, numChannels, true); offset += 2;
            view.setUint32(offset, sampleRate, true); offset += 4;
            view.setUint32(offset, byteRate, true); offset += 4;
            view.setUint16(offset, blockAlign, true); offset += 2;
            view.setUint16(offset, bitsPerSample, true); offset += 2;

            // data chunk
            writeString('data');
            view.setUint32(offset, dataSize, true); offset += 4;

            // PCM data
            for (let i = 0; i < pcm16.length; i++) {
                view.setInt16(offset, pcm16[i], true);
                offset += 2;
            }

            return new Blob([buffer], { type: 'audio/wav' });
        }

        async function callTTS(text) {
            if (state.g4_isCalling) return;

            state.g4_isCalling = true;
            renderGame4(); 

            try {
                const payload = {
                    contents: [{
                        parts: [{ text: text }]
                    }],
                    generationConfig: {
                        responseModalities: ["AUDIO"],
                        speechConfig: {
                            voiceConfig: {
                                prebuiltVoiceConfig: { voiceName: "Kore" }
                            }
                        }
                    },
                    model: "gemini-2.5-flash-preview-tts"
                };
                
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`TTS API error: ${response.status}`);
                }
                
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    const sampleRate = sampleRateMatch ? parseInt(sampleRateMatch[1], 10) : 16000;
                    
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    
                    const audio = new Audio(audioUrl);
                    await new Promise(resolve => {
                        audio.onended = resolve;
                        audio.play().catch(e => {
                            console.error("Audio playback failed:", e);
                            resolve(); // resolve even on failure to unblock
                        });
                    });
                } else {
                    console.error("TTS response missing audio data.");
                    MessageBox.show("èªéŸ³ç”Ÿæˆå¤±æ•—æˆ–è³‡æ–™æ ¼å¼éŒ¯èª¤ã€‚", true);
                }

            } catch (error) {
                console.error("TTS API call failed:", error);
                MessageBox.show(`èªéŸ³ç”Ÿæˆå¤±æ•—: ${error.message}`, true);
            } finally {
                state.g4_isCalling = false;
                renderGame4();
            }
        }

        // éŒ¯èª¤è™•ç†æ¨¡çµ„
        const MessageBox = {
            show: (message, isError = true) => {
                const box = document.getElementById('message-box');
                const content = document.getElementById('message-content');
                
                content.textContent = message;
                box.classList.remove('hidden', 'bg-red-500', 'bg-green-500');
                box.classList.add(isError ? 'bg-red-500' : 'bg-green-500');

                setTimeout(() => box.classList.add('hidden'), 3000);
            }
        };

        // Firebase åˆå§‹åŒ–èˆ‡èªè­‰
        async function initializeFirebase() {
            if (!firebaseConfig || !window.firebaseImports) {
                console.error("Firebase config or imports are missing.");
                MessageBox.show("ç³»çµ±éŒ¯èª¤ï¼šFirebase è¨­å®šç¼ºå¤±ã€‚");
                return;
            }
            
            const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, setLogLevel } = window.firebaseImports;
            
            setLogLevel('Debug');
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);

            if (initialAuthToken) {
                try {
                    await signInWithCustomToken(auth, initialAuthToken);
                } catch (error) {
                    console.error("Custom token sign-in failed, falling back to anonymous:", error);
                    await signInAnonymously(auth);
                }
            } else {
                await signInAnonymously(auth);
            }

            onAuthStateChanged(auth, (user) => {
                const userIdDisplay = document.getElementById('user-id-display'); 
                
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    console.log("Firebase initialized. User ID:", userId);
                    if (userIdDisplay) { 
                        userIdDisplay.textContent = `ç”¨æˆ¶ID: ${userId}`;
                    }
                    
                    subscribeToWordList();
                    renderApp();

                } else {
                    console.log("No user signed in.");
                    isAuthReady = false;
                }
            });
        }

        // Firestore è¨‚é–± (ç”¨æ–¼å–®å­—åº«)
        function subscribeToWordList() {
            if (!db || !userId) return;
            const { collection, query, onSnapshot } = window.firebaseImports;
            
            const path = `artifacts/${appId}/users/${userId}/${FIREBASE_COLLECTION}`;
            const q = query(collection(db, path));

            onSnapshot(q, (snapshot) => {
                wordList = [];
                snapshot.forEach((doc) => {
                    wordList.push({ id: doc.id, ...doc.data() });
                });
                console.log("Words updated from Firestore:", wordList);
                
                if (currentGame === 'admin') renderWordAdmin();
                if (currentGame === 'game3' || currentGame === 'game4') renderApp(); 
            }, (error) => {
                console.error("Error subscribing to words:", error);
                MessageBox.show("ç„¡æ³•è¼‰å…¥å–®å­—åˆ—è¡¨ã€‚");
            });
        }

        // --- æ ¸å¿ƒæ‡‰ç”¨ç¨‹å¼æ§åˆ¶ ---
        function setTabActive(gameName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
                btn.classList.add('bg-white', 'text-gray-700', 'shadow-md');
            });

            const activeTab = document.getElementById(`tab-${gameName}`);
            if (activeTab) {
                activeTab.classList.remove('bg-white', 'text-gray-700', 'shadow-md');
                activeTab.classList.add('bg-primary-pink', 'text-white', 'shadow-xl', 'scale-105');
            }
        }

        function changeGame(gameName) {
            currentGame = gameName;
            setTabActive(gameName);
            if (isAuthReady) {
                renderApp();
            }
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function renderApp() {
            if (!isAuthReady) return;

            switch (currentGame) {
                case 'game1':
                    renderGame1();
                    break;
                case 'game2':
                    initGame2();
                    break;
                case 'game3':
                    state.g3_gameStatus = 'ready';
                    initGame3();
                    break;
                case 'game4':
                    initGame4(); // Bingo
                    break;
                case 'game5':
                    initGame5();
                    break;
                case 'admin':
                    renderWordAdmin();
                    break;
            }
        }

        window.onload = function() {
            // FIX: ç¢ºä¿åˆå§‹éŠæˆ²ç•«é¢åœ¨ Firebase ç•°æ­¥è¼‰å…¥å‰æ¸²æŸ“å‡ºä¾†ï¼Œé¿å…ç•«é¢ç©ºç™½ã€‚
            setTabActive(currentGame);
            renderGame1(); 
            
            initializeFirebase();
        }
    </script>


    <script>
        // --- éŠæˆ² 1 (æ‹¼éŸ³ç™½æ¿) é‚è¼¯ ---
        function renderGame1() {
            const html = `
                <section class="w-full bg-secondary-blue p-2 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ“ å­—æ¯ç™½æ¿æ‹¼éŸ³å·¥å…· (Phonics Whiteboard)</h2>
                    <!-- ç™½æ¿é¡¯ç¤ºå€ -->
                    <div id="whiteboard-display" 
                         class="whiteboard-display min-h-[100px] w-full bg-white rounded-lg p-3 md:p-6 overflow-x-auto whitespace-nowrap text-left 
                                text-3xl md:text-5xl font-extrabold text-gray-800 border-2 border-gray-300">
                        <!-- å…§å®¹ç”± JS æ¸²æŸ“ -->
                    </div>
                    <p class="text-xs md:text-sm text-blue-900 mt-2 text-center">ğŸ’¡ é»é¸ç™½æ¿ä¸Šçš„å­—æ¯å³å¯åˆªé™¤ï¼Œæ¸¸æ¨™æœƒè‡ªå‹•ç§»å›è©²è™•ã€‚</p>
                </section>

                <section class="w-full bg-keyboard-bg p-4 rounded-xl shadow-lg border-b-8 border-accent-yellow">
                    
                    <!-- å­—æ¯éµç›¤ (A-Z) -->
                    <div id="keyboard-alphabet" class="grid grid-cols-7 md:grid-cols-10 gap-2 mb-4">
                        ${ALPHABET.map(letter => `
                            <button onclick="insertLetterG1('${letter}')" 
                                    class="key-btn bg-white hover:bg-secondary-blue active:shadow-key-active shadow-cute text-2xl md:text-4xl font-extrabold text-gray-800 rounded-xl transition duration-150">
                                ${letter}
                            </button>
                        `).join('')}
                    </div>

                    <!-- ç‰¹æ®ŠåŠŸèƒ½éµ -->
                    <div class="grid grid-cols-4 gap-2">
                        <!-- å·¦ç§»éµ -->
                        <button onclick="moveCursorG1('left')" 
                                class="key-btn bg-accent-yellow hover:bg-yellow-400 active:shadow-key-active shadow-cute text-xl md:text-3xl font-bold text-yellow-900 rounded-xl">
                            <span aria-label="å·¦ç§»">&leftarrow;</span>
                        </button>
                        <!-- åˆªé™¤éµ -->
                        <button onclick="deleteLeftG1()" 
                                class="key-btn bg-red-400 hover:bg-red-500 active:shadow-key-active shadow-cute text-xl md:text-2xl font-bold text-white rounded-xl">
                            åˆªé™¤
                        </button>
                        <!-- ç©ºç™½éµ (ä½”å…©æ ¼) -->
                        <button onclick="insertSpaceG1()" 
                                class="key-btn col-span-2 bg-green-400 hover:bg-green-500 active:shadow-key-active shadow-cute text-lg md:text-2xl font-bold text-white rounded-xl">
                            ç©ºç™½éµ
                        </button>
                        <!-- å³ç§»éµ -->
                        <button onclick="moveCursorG1('right')" 
                                class="key-btn bg-accent-yellow hover:bg-yellow-400 active:shadow-key-active shadow-cute text-xl md:text-3xl font-bold text-yellow-900 rounded-xl">
                            <span aria-label="å³ç§»">&rightarrow;</span>
                        </button>
                    </div>
                </section>
            `;
            document.getElementById('game-content').innerHTML = html;
            renderWhiteboardG1(); 
        }

        function renderWhiteboardG1() {
            const whiteboard = document.getElementById('whiteboard-display');
            if (!whiteboard) return;
            whiteboard.innerHTML = '';
            
            const displayArray = [...state.g1_currentWord];
            const cursorElement = `<span id="cursor-element" class="cursor text-3xl md:text-5xl font-extrabold text-gray-800 select-none">|</span>`;
            displayArray.splice(state.g1_cursorIndex, 0, cursorElement);

            let htmlContent = '';
            
            displayArray.forEach((item, index) => {
                if (item.includes('cursor-element')) {
                    htmlContent += item; 
                } else {
                    const originalIndex = index < state.g1_cursorIndex ? index : index - 1;

                    if (item === ' ') {
                        htmlContent += `<span class="inline-block mx-2 text-3xl md:text-5xl font-extrabold text-gray-400 select-none">_</span>`;
                    } else {
                        htmlContent += `<span onclick="deleteClickedLetterG1(${originalIndex})" 
                                             class="whiteboard-letter transition-colors duration-150 p-1 rounded-md hover:bg-red-200 cursor-pointer 
                                                    text-3xl md:text-5xl font-extrabold text-gray-800">
                                           ${item}
                                       </span>`;
                    }
                }
            });
            whiteboard.innerHTML = htmlContent;
            whiteboard.scrollLeft = whiteboard.scrollWidth;
        }

        function insertLetterG1(char) {
            if (state.g1_currentWord.length >= 40) return; 
            state.g1_currentWord.splice(state.g1_cursorIndex, 0, char);
            state.g1_cursorIndex++;
            renderWhiteboardG1();
        }

        function deleteClickedLetterG1(indexToDelete) {
            if (indexToDelete >= 0 && indexToDelete < state.g1_currentWord.length) {
                state.g1_currentWord.splice(indexToDelete, 1);
                state.g1_cursorIndex = indexToDelete; 
                renderWhiteboardG1();
            }
        }

        function deleteLeftG1() {
            if (state.g1_cursorIndex > 0) {
                state.g1_currentWord.splice(state.g1_cursorIndex - 1, 1);
                state.g1_cursorIndex--;
                renderWhiteboardG1();
            }
        }

        function insertSpaceG1() {
            insertLetterG1(' ');
        }

        function moveCursorG1(direction) {
            if (direction === 'left' && state.g1_cursorIndex > 0) {
                state.g1_cursorIndex--;
            } else if (direction === 'right' && state.g1_cursorIndex < state.g1_currentWord.length) {
                state.g1_cursorIndex++;
            }
            renderWhiteboardG1();
        }
        // --- éŠæˆ² 1 (æ‹¼éŸ³ç™½æ¿) é‚è¼¯çµæŸ ---


        // --- éŠæˆ² 2 (å­—æ¯å°å°ç¢°) é‚è¼¯ ---
        function initGame2() {
            state.g2_matchCount = 0;
            state.g2_flippedCards = [];
            
            let cardValues = [];
            
            state.g2_letters.forEach((l, index) => {
                const color = G2_COLOR_PALETTE[index % G2_COLOR_PALETTE.length];
                const lower = l.toLowerCase();
                const upper = l.toUpperCase();
                
                const groupId = `match-${lower}`; 

                cardValues.push({ id: crypto.randomUUID(), value: upper, groupId, color, matched: false, flipped: false });
                cardValues.push({ id: crypto.randomUUID(), value: lower, groupId, color, matched: false, flipped: false });
            });
            
            for (let i = cardValues.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [cardValues[i], cardValues[j]] = [cardValues[j], cardValues[i]];
            }
            state.g2_matchCards = cardValues;
            renderGame2();
        }

        function handleCardClickG2(id) {
            const cardIndex = state.g2_matchCards.findIndex(c => c.id === id);
            const card = state.g2_matchCards[cardIndex];

            if (!card) return;
            // ä¿®æ­£: å°‡å¡ç‰‡æ•¸é‡å¾ 12 æ¸›å°‘åˆ° 8 å¾Œï¼Œç¶²æ ¼ä½ˆå±€ä¹Ÿè¦èª¿æ•´
            if (card.matched || card.flipped || state.g2_flippedCards.length === 2) {
                return;
            }

            card.flipped = true;
            state.g2_flippedCards.push(card);
            renderGame2(); 

            if (state.g2_flippedCards.length === 2) {
                const [card1, card2] = state.g2_flippedCards;
                
                if (card1.groupId === card2.groupId) {
                    card1.matched = true;
                    card2.matched = true;
                    state.g2_matchCount++;
                    
                    state.g2_flippedCards = []; 
                    renderGame2(); 
                    
                    if (state.g2_matchCount === state.g2_letters.length) {
                        setTimeout(() => MessageBox.show("å¤ªæ£’äº†ï¼æ‰€æœ‰é…å°æˆåŠŸï¼ğŸ‰", false), 500);
                    }
                } else {
                    setTimeout(() => {
                        const index1 = state.g2_matchCards.findIndex(c => c.id === card1.id);
                        const index2 = state.g2_matchCards.findIndex(c => c.id === card2.id);
                        
                        if (index1 !== -1) state.g2_matchCards[index1].flipped = false;
                        if (index2 !== -1) state.g2_matchCards[index2].flipped = false;
                        
                        state.g2_flippedCards = [];
                        renderGame2(); 
                    }, 1000);
                }
            }
        }

        function renderGame2() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game2') return;

            const cardsHtml = state.g2_matchCards.map(card => {
                const color = card.color;
                
                let cardClasses = `h-24 md:h-32 match-card-item shadow-xl hover:shadow-2xl`;
                let content = '';
                let innerTextClass = `text-4xl md:text-5xl font-extrabold`;

                if (card.matched) {
                    cardClasses += ` matched-success ${card.matched ? '' : 'cursor-default'}`; 
                    content = card.value;
                    innerTextClass += ` text-white`;
                } else if (card.flipped) {
                    cardClasses += ` ${color.bg} ${color.border}`;
                    content = card.value;
                    innerTextClass += ` ${color.text}`;
                } else {
                    cardClasses += ` bg-secondary-blue border-blue-600`;
                    content = '?';
                    innerTextClass += ` text-blue-900`;
                }

                return `
                    <div class="h-24 md:h-32 rounded-xl" onclick="handleCardClickG2('${card.id}')">
                        <div class="${cardClasses}">
                            <span class="${innerTextClass}">
                                ${content}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            // ä¿®æ­£: å°‡ç¶²æ ¼ä½ˆå±€å¾ grid-cols-4 (12 å¼µå¡ç‰‡) èª¿æ•´ç‚º grid-cols-4 (8 å¼µå¡ç‰‡)
            container.innerHTML = `
                <section class="w-full bg-accent-yellow p-4 rounded-xl shadow-inner border-b-8 border-yellow-600">
                    <h2 class="text-xl md:text-3xl font-bold text-yellow-900 mb-4 text-center">ğŸ§© å­—æ¯å°å°ç¢° (Letter Match-Up)</h2>
                    <p class="text-center text-sm mb-4">ç›®æ¨™: é»æ“Šå¡ç‰‡ï¼Œé…å°å¤§å°å¯«å­—æ¯ã€‚</p>
                    <div id="match-game-grid" class="grid grid-cols-4 gap-3 md:gap-4 max-w-lg mx-auto">
                        ${cardsHtml}
                    </div>
                    <div class="text-center mt-6">
                        <button onclick="initGame2()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            ${state.g2_matchCount === state.g2_letters.length ? 'å†ç©ä¸€æ¬¡' : 'é‡æ–°é–‹å§‹'}
                        </button>
                    </div>
                </section>
            `;
        }
        // --- éŠæˆ² 2 (å­—æ¯å°å°ç¢°) é‚è¼¯çµæŸ ---


        // --- éŠæˆ² 3 (Hangman) é‚è¼¯ ---
        
        // Hangman ç¹ªåœ– SVG åŠ©æ‰‹å‡½æ•¸
        function getHangmanSVG(wrongGuesses, status) {
            const parts = [];
            const color = status === 'won' ? '#3CB371' : (status === 'lost' ? '#FF4500' : '#4A5568'); 
            const strokeStyle = `stroke="${color}" stroke-width="6" stroke-linecap="round"`;
            
            // Base Gallows (Gallows, Crossbar, Rope - 3 parts)
            parts.push(`<line x1="50" y1="200" x2="150" y2="200" stroke="${color}" stroke-width="6"/>`); 
            parts.push(`<line x1="100" y1="200" x2="100" y2="20" stroke="${color}" stroke-width="6"/>`); 
            parts.push(`<line x1="100" y1="20" x2="160" y2="20" stroke="${color}" stroke-width="6"/>`); 
            parts.push(`<line x1="160" y1="20" x2="160" y2="40" stroke="${color}" stroke-width="3"/>`); 

            // Character Drawing (6 parts for the body)
            
            // 1. Head
            if (wrongGuesses >= 1) {
                parts.push(`<circle cx="160" cy="60" r="20" stroke="${color}" stroke-width="3" fill="none"/>`);
            }

            // 2. Body
            if (wrongGuesses >= 2) {
                parts.push(`<line x1="160" y1="80" x2="160" y2="140" ${strokeStyle}/>`);
            }

            // 3. Left Arm
            if (wrongGuesses >= 3) {
                parts.push(`<line x1="160" y1="90" x2="140" y2="110" ${strokeStyle}/>`);
            }

            // 4. Right Arm
            if (wrongGuesses >= 4) {
                parts.push(`<line x1="160" y1="90" x2="180" y2="110" ${strokeStyle}/>`);
            }

            // 5. Left Leg
            if (wrongGuesses >= 5) {
                parts.push(`<line x1="160" y1="140" x2="140" y2="160" ${strokeStyle}/>`);
            }

            // 6. Right Leg (Game Over)
            if (wrongGuesses >= 6) {
                parts.push(`<line x1="160" y1="140" x2="180" y2="160" ${strokeStyle}/>`);
            }
            
            // Add expressions for Game Over
            if (status === 'lost') {
                // X eyes and Sad Mouth
                parts.push(`<line x1="150" y1="50" x2="155" y2="55" stroke="#FF4500" stroke-width="2"/>`);
                parts.push(`<line x1="155" y1="50" x2="150" y2="55" stroke="#FF4500" stroke-width="2"/>`);
                parts.push(`<line x1="165" y1="50" x2="170" y2="55" stroke="#FF4500" stroke-width="2"/>`);
                parts.push(`<line x1="170" y1="50" x2="165" y2="55" stroke="#FF4500" stroke-width="2"/>`);
                parts.push(`<path d="M150 70 Q160 80 170 70" fill="none" stroke="#FF4500" stroke-width="3"/>`);
            } else if (status === 'won') {
                // Happy face
                parts.push(`<circle cx="155" cy="50" r="2" fill="#3CB371"/>`);
                parts.push(`<circle cx="165" cy="50" r="2" fill="#3CB371"/>`);
                parts.push(`<path d="M155 70 Q160 60 165 70" fill="none" stroke="#3CB371" stroke-width="3"/>`);
            }


            return `<svg width="200" height="220" viewBox="0 0 200 220" xmlns="http://www.w3.org/2000/svg">
                        ${parts.join('')}
                    </svg>`;
        }


        async function initGame3() {
            if (wordList.length === 0) {
                state.g3_gameStatus = 'no_words';
                renderGame3();
                MessageBox.show("è«‹å…ˆåˆ°ã€Œå–®å­—å¾Œå°ã€æ–°å¢å–®å­—ï¼");
                return;
            }
            
            const randomWordObj = wordList[Math.floor(Math.random() * wordList.length)];
            state.g3_currentGuessWord = randomWordObj.word.toUpperCase();
            state.g3_guessedLetters = new Set();
            state.g3_wrongGuesses = 0;
            state.g3_gameStatus = 'playing';
            
            // ç§»é™¤éœæ…‹åœ–ç‰‡ URL
            state.g3_imageUrl = ''; 
            
            renderGame3(); 
        }

        function guessLetterG3(letter) {
            if (state.g3_gameStatus !== 'playing' || state.g3_guessedLetters.has(letter)) return;
            
            state.g3_guessedLetters.add(letter);
            
            if (!state.g3_currentGuessWord.includes(letter)) {
                state.g3_wrongGuesses++;
            }
            checkWinConditionG3();
            renderGame3();
        }

        function checkWinConditionG3() {
            const hiddenWord = state.g3_currentGuessWord.split('').filter(char => char !== ' ');
            const guessedCorrectly = hiddenWord.every(char => state.g3_guessedLetters.has(char));

            if (guessedCorrectly) {
                state.g3_gameStatus = 'won';
                MessageBox.show(`æ­å–œæ‚¨ï¼ŒçŒœå°äº†ï¼ğŸ‰ å–®å­—æ˜¯ ${state.g3_currentGuessWord}ï¼`, false);
            } else if (state.g3_wrongGuesses >= state.g3_MAX_WRONG) {
                state.g3_gameStatus = 'lost';
                MessageBox.show(`å¾ˆå¯æƒœï¼Œå¤±æ•—äº†ã€‚ğŸ˜­ æ­£ç¢ºå–®å­—æ˜¯ ${state.g3_currentGuessWord}ã€‚`, true);
            }
        }

        function renderGame3() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game3') return;
            
            if (state.g3_gameStatus === 'no_words') {
                container.innerHTML = `<p class="text-red-500 text-center text-xl p-8">éŠæˆ²ç„¡æ³•é–‹å§‹ï¼Œè«‹å…ˆåˆ°ã€Œå–®å­—å¾Œå°ã€æ–°å¢å–®å­—ã€‚</p>`;
                return;
            }

            const displayWord = state.g3_currentGuessWord.split('').map(char => {
                if (char === ' ') return '&nbsp;&nbsp;'; 
                const isGameOver = state.g3_gameStatus === 'won' || state.g3_gameStatus === 'lost';
                if (state.g3_guessedLetters.has(char) || isGameOver) {
                    return char;
                }
                return '_';
            }).join(' ');

            const alphabetBtns = ALPHABET.map(letter => {
                let btnClass = 'bg-white hover:bg-secondary-blue';
                let onClick = `guessLetterG3('${letter}')`;

                if (state.g3_guessedLetters.has(letter)) {
                    btnClass = state.g3_currentGuessWord.includes(letter) ? 'bg-green-400 cursor-not-allowed' : 'bg-red-400 cursor-not-allowed';
                    onClick = '';
                }

                if (state.g3_gameStatus !== 'playing') {
                    btnClass = 'bg-gray-300 cursor-not-allowed';
                    onClick = '';
                }

                return `
                    <button onclick="${onClick}" 
                            class="key-btn ${btnClass} active:shadow-key-active shadow-cute text-xl md:text-3xl font-extrabold rounded-xl transition duration-150 text-gray-800">
                        ${letter}
                    </button>
                `;
            }).join('');

            const errorIndicator = `<div class="flex justify-center space-x-2 mt-2">
                ${Array(state.g3_MAX_WRONG).fill(0).map((_, i) => `
                    <div class="w-6 h-6 rounded-full ${i < state.g3_wrongGuesses ? 'bg-red-600 shadow-lg' : 'bg-gray-300'}"></div>
                `).join('')}
                <p class="text-sm text-gray-600 ml-3">éŒ¯èª¤æ¬¡æ•¸: ${state.g3_wrongGuesses}/${state.g3_MAX_WRONG}</p>
            </div>`;

            // Hangman ç¹ªåœ–å€
            const hangmanDrawing = getHangmanSVG(state.g3_wrongGuesses, state.g3_gameStatus);
            
            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-2 text-center">ğŸ–ï¸ å¯æ„› Hangman çŒœå–®å­— (Hangman Word Guess)</h2>
                </section>
                
                <div class="flex flex-col md:flex-row gap-6">
                    <!-- å·¦å´: Hangman ç¹ªåœ–èˆ‡éŒ¯èª¤æŒ‡ç¤º -->
                    <div class="flex-1 p-4 bg-white rounded-xl shadow-md border-2 border-gray-200 flex flex-col items-center">
                        <p class="text-lg font-semibold text-center mb-2 text-blue-800">ğŸ’” éŒ¯èª¤æ¬¡æ•¸: ${state.g3_wrongGuesses}/${state.g3_MAX_WRONG}</p>
                        <div class="w-full max-w-sm h-[250px] flex items-center justify-center mx-auto p-4">
                            ${hangmanDrawing}
                        </div>
                        ${errorIndicator}
                    </div>

                    <!-- å³å´: çŒœæ¸¬å€ -->
                    <div class="flex-1 p-4 bg-keyboard-bg rounded-xl shadow-md border-2 border-gray-200">
                        <p class="text-lg font-semibold text-center mb-4 text-blue-800">çŒœæ¸¬å–®å­—:</p>
                        <div class="text-center text-4xl md:text-6xl font-extrabold tracking-widest mb-6 p-2 bg-white rounded-lg border-b-4 border-gray-300 whitespace-nowrap overflow-x-auto">
                            ${displayWord}
                        </div>
                        
                        <div class="grid grid-cols-7 gap-1 md:gap-2">
                            ${alphabetBtns}
                        </div>
                        
                        <div class="text-center mt-6">
                            <button onclick="initGame3()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                                ${state.g3_gameStatus === 'playing' ? 'é‡è¨­éŠæˆ²' : 'é–‹å§‹æ–°éŠæˆ²'}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        // --- éŠæˆ² 3 (Hangman) é‚è¼¯çµæŸ ---


        // --- éŠæˆ² 4 (é›™äººè‹±æ–‡è³“æœ) é‚è¼¯ ---
        function shuffleArray(array) {
            let temp = [...array];
            for (let i = temp.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [temp[i], temp[j]] = [temp[j], temp[i]];
            }
            return temp;
        }

        function generateBingoCard() {
            const requiredSize = BINGO_SIZE * BINGO_SIZE; // 4x4 = 16
            if (BINGO_DICTIONARY.length < requiredSize) {
                MessageBox.show(`è³“æœå–®å­—åº«ä¸è¶³ ${requiredSize} å€‹ï¼Œè«‹æ›´æ–°ç¨‹å¼ç¢¼ã€‚`, true);
                return Array(requiredSize).fill('ERROR');
            }
            const shuffledWords = shuffleArray(BINGO_DICTIONARY);
            return shuffledWords.slice(0, requiredSize); // Slice to 16 words
        }

        function checkWinG4(player) {
            let lines = 0;
            const size = BINGO_SIZE; // size = 4
            const card = player.card;
            const marked = player.marked;
            const cardLength = size * size;

            // æª¢æŸ¥æ‰€æœ‰è¡Œå’Œåˆ—
            for (let i = 0; i < size; i++) {
                let rowCount = 0;
                let colCount = 0;
                for (let j = 0; j < size; j++) {
                    // Row check (0,1,2,3), (4,5,6,7), ...
                    if (marked.has(card[i * size + j])) rowCount++;
                    // Col check (0,4,8,12), (1,5,9,13), ...
                    if (marked.has(card[j * size + i])) colCount++;
                }
                if (rowCount === size) lines++;
                if (colCount === size) lines++;
            }

            // æª¢æŸ¥å°è§’ç·š (ä¸»å°è§’ç·š)
            let diag1Count = 0;
            for (let i = 0; i < size; i++) {
                if (marked.has(card[i * size + i])) diag1Count++;
            }
            if (diag1Count === size) lines++;

            // æª¢æŸ¥åå°è§’ç·š
            let diag2Count = 0;
            for (let i = 0; i < size; i++) {
                // Indices: (3), (6), (9), (12) for 4x4
                if (marked.has(card[i * size + (size - 1 - i)])) diag2Count++;
            }
            if (diag2Count === size) lines++;
            
            player.score = lines;
            // ä¿®æ­£: ç²å‹æ¢ä»¶æ”¹ç‚ºé€£å…©æ¢ç·š
            return lines >= 2; 
        }

        function initGame4() {
            // Crossword ç›¸é—œç‹€æ…‹ä¸å†éœ€è¦ï¼Œä½†ç‚ºäº†å…¼å®¹èˆŠç‰ˆä»£ç¢¼ï¼Œæ¸…ç©ºä¸€ä¸‹
            state.g4_answers = [];               
            state.g4_grid = []; 
            state.g4_activeSlots = [];           
            state.g4_cellContents = {};          
            state.g4_solutionContents = {};      
            
            // Bingo åˆå§‹åŒ–
            state.g4_players[0].card = generateBingoCard();
            state.g4_players[0].marked = new Set();
            state.g4_players[0].winner = false;
            state.g4_players[0].score = 0;

            state.g4_players[1].card = generateBingoCard();
            state.g4_players[1].marked = new Set();
            state.g4_players[1].winner = false;
            state.g4_players[1].score = 0;

            state.g4_calledWords = new Set();
            state.g4_lastCalledWord = '';
            state.g4_gameStatus = 'ready'; // ready -> calling -> finished
            state.g4_isCalling = false;
            
            renderGame4();
        }

        async function startCallingG4() {
            if (state.g4_gameStatus === 'finished') {
                initGame4(); // é‡æ–°é–‹å§‹
                return;
            }
            
            if (state.g4_isCalling) return;
            
            state.g4_gameStatus = 'calling';
            
            const availableWords = shuffleArray(BINGO_DICTIONARY.filter(w => !state.g4_calledWords.has(w)));
            
            if (availableWords.length === 0) {
                 MessageBox.show("å–®å­—åº«å·²æŠ½å®Œï¼", true);
                 return;
            }
            
            const nextWord = availableWords[0];
            state.g4_lastCalledWord = nextWord;
            state.g4_calledWords.add(nextWord);
            
            // èªéŸ³æ’­å ±
            await callTTS(nextWord);
            
            // æª¢æŸ¥æ˜¯å¦æœ‰è´å®¶
            let winnerFound = false;
            state.g4_players.forEach(player => {
                if (checkWinG4(player)) {
                    player.winner = true;
                    winnerFound = true;
                }
            });

            if (winnerFound) {
                state.g4_gameStatus = 'finished';
                renderGame4();
                MessageBox.show(`è³“æœï¼ç©å®¶ ${state.g4_players.filter(p => p.winner).map(p => p.id).join(' å’Œ ')} ç²å‹ï¼`, false);
            } else {
                renderGame4();
            }
        }

        function handleCardClickG4(playerId, index) {
            const player = state.g4_players.find(p => p.id === playerId);
            if (!player || state.g4_gameStatus !== 'calling' || player.winner) return;

            const word = player.card[index];

            if (state.g4_calledWords.has(word)) {
                if (player.marked.has(word)) {
                    player.marked.delete(word); // å–æ¶ˆæ¨™è¨˜ (å¯é¸)
                } else {
                    player.marked.add(word); // æ¨™è¨˜
                }

                // æª¢æŸ¥æ˜¯å¦ç²å‹
                if (checkWinG4(player)) {
                    player.winner = true;
                    state.g4_gameStatus = 'finished';
                    MessageBox.show(`è³“æœï¼ç©å®¶ ${playerId} ç²å‹ï¼`, false);
                }
                renderGame4();
            } else {
                MessageBox.show(`å–®å­— ${word} å°šæœªè¢«å”¸å‡ºï¼`, true);
            }
        }

        function renderGame4() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game4') return;
            
            const renderCard = (player) => {
                const cellsHtml = player.card.map((word, index) => {
                    const isMarked = player.marked.has(word);
                    return `
                        <div class="bingo-cell ${isMarked ? 'marked' : 'hover:bg-yellow-300'}" 
                             onclick="handleCardClickG4(${player.id}, ${index})">
                            ${word}
                        </div>
                    `;
                }).join('');

                return `
                    <div class="flex-1 min-w-0 p-3 rounded-xl shadow-lg border-4 ${player.winner ? 'border-green-600 bg-green-100' : 'border-secondary-blue bg-white'}">
                        <h3 class="text-xl font-bold text-center mb-3 ${player.winner ? 'text-green-700' : 'text-blue-800'}">
                            ${player.name} ${player.winner ? 'ğŸ‰ WINNER ğŸ‰' : ''} (ç·šæ•¸: ${player.score})
                        </h3>
                        <!-- ä¿®æ­£: 4x4 ç¶²æ ¼ -->
                        <div class="bingo-grid mx-auto" style="grid-template-columns: repeat(${BINGO_SIZE}, 1fr); grid-template-rows: repeat(${BINGO_SIZE}, 1fr);">
                            ${cellsHtml}
                        </div>
                    </div>
                `;
            };

            const controlArea = `
                <div class="text-center p-4 bg-keyboard-bg rounded-xl shadow-lg border-b-8 border-accent-yellow">
                    <h3 class="text-2xl font-bold text-gray-800 mb-3">
                        ${state.g4_gameStatus === 'ready' ? 'æº–å‚™é–‹å§‹' : state.g4_gameStatus === 'calling' ? 'éŠæˆ²ä¸­' : 'éŠæˆ²çµæŸ'}
                    </h3>
                    
                    <div class="mb-4 h-12 flex items-center justify-center">
                        <p class="text-3xl font-extrabold text-red-600 transition duration-300">
                            ${state.g4_lastCalledWord ? `æœ€æ–°å–®å­—: ${state.g4_lastCalledWord}` : state.g4_gameStatus === 'ready' ? 'é»æ“Šé–‹å§‹æŒ‰éˆ•' : 'ç­‰å¾…ä¸‹ä¸€è¼ª...'}
                        </p>
                    </div>

                    <button onclick="startCallingG4()" 
                            class="bg-primary-pink hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl transition duration-200 
                                ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${state.g4_isCalling || state.g4_gameStatus === 'finished' ? 'disabled' : ''}>
                        ${state.g4_gameStatus === 'ready' ? 'ğŸ”Š é–‹å§‹éŠæˆ² / æŠ½å–å–®å­—' : state.g4_gameStatus === 'calling' ? (state.g4_isCalling ? 'ğŸ™ï¸ æ’­å ±ä¸­...' : 'ğŸ”Š æŠ½å–ä¸‹ä¸€å€‹å–®å­—') : 'ğŸ”„ é‡æ–°é–‹å§‹'}
                    </button>
                    <p class="text-xs text-gray-600 mt-2">å·²æŠ½å‡º ${state.g4_calledWords.size} å€‹å–®å­— / å‰©é¤˜ ${BINGO_DICTIONARY.length - state.g4_calledWords.size} å€‹</p>
                </div>
            `;

            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-4 text-center">ğŸ° é›™äººè‹±æ–‡è³“æœ (Two-Player Bingo)</h2>
                    <!-- ä¿®æ­£: æè¿°æ–‡å­—åæ˜  4x4 å’Œå…©æ¢ç·šç²å‹ -->
                    <p class="text-center text-sm text-blue-900 mb-6">ç›®æ¨™: é»æ“Šä¸­å¤®æŒ‰éˆ•è½å–å–®å­—ï¼Œä¸¦åœ¨æ‚¨çš„ 4x4 è³“æœå¡ä¸Šæ¨™è¨˜ã€‚æœ€å…ˆå®Œæˆå…©æ¢ç·šï¼ˆæ°´å¹³ã€å‚ç›´æˆ–å°è§’ç·šï¼‰è€…ç²å‹ï¼</p>
                    
                    ${controlArea}
                    
                    <!-- è³“æœå¡ä¸¦æ’é¡¯ç¤º -->
                    <div class="flex flex-col md:flex-row gap-6 mt-6">
                        ${renderCard(state.g4_players[0])}
                        ${renderCard(state.g4_players[1])}
                    </div>
                </section>
            `;
        }
        // --- éŠæˆ² 4 (é›™äººè‹±æ–‡è³“æœ) é‚è¼¯çµæŸ ---


        // --- éŠæˆ² 5: å­—æ¯é †åºæ’åº (Letter Order Sort) é‚è¼¯ ---
        function initGame5() {
            const totalLetters = 4;
            let randomLetters = ALPHABET.sort(() => 0.5 - Math.random()).slice(0, totalLetters);
            
            state.g5_letters = randomLetters.map(l => ({ id: crypto.randomUUID(), value: l, isDropped: false }));
            state.g5_answer = [...randomLetters].sort(); // æ­£ç¢ºç­”æ¡ˆ ( sorted )
            state.g5_currentSort = Array(totalLetters).fill(null); 

            renderGame5();
        }
        
        function speakLettersG5() {
            if (!('speechSynthesis' in window)) {
                MessageBox.show("æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒèªéŸ³æ’­æ”¾åŠŸèƒ½ã€‚", true);
                return;
            }
            
            // ä¿®æ­£: å”¸å‡ºæ­£ç¢ºçš„å­—æ¯é †åº (state.g5_answer)
            const lettersToSpeak = state.g5_answer.join(', '); 
            
            const speakSequence = (count) => {
                if (count >= 3) return;
                
                const utterance = new SpeechSynthesisUtterance(lettersToSpeak);
                utterance.lang = 'en-US'; 
                utterance.rate = 0.8; 
                
                utterance.onend = () => {
                    setTimeout(() => speakSequence(count + 1), 500); 
                };
                window.speechSynthesis.speak(utterance);
            };

            speakSequence(0);
        }

        function handleLetterClickG5(id) {
            const letter = state.g5_letters.find(l => l.id === id);
            if (!letter || letter.isDropped) return;

            const targetIndex = state.g5_currentSort.findIndex(item => item === null);

            if (targetIndex !== -1) {
                state.g5_currentSort[targetIndex] = letter.value;
                letter.isDropped = true; 
                renderGame5();
                checkCompletionG5();
            }
        }
        
        function handleResetTargetG5(index) {
            const char = state.g5_currentSort[index];
            if (!char) return;

            const letter = state.g5_letters.find(l => l.value === char);
            if (letter) {
                letter.isDropped = false;
            }
            
            state.g5_currentSort[index] = null;
            renderGame5();
        }

        function checkCompletionG5() {
            if (state.g5_currentSort.some(item => item === null)) return;
            
            const currentWord = state.g5_currentSort.join('');
            const answerWord = state.g5_answer.join('');
            
            if (currentWord === answerWord) {
                MessageBox.show("æ­å–œï¼å­—æ¯é †åºå®Œå…¨æ­£ç¢ºï¼ğŸ‰", false);
            } else {
                const targetBoxes = document.querySelectorAll('.target-box');
                targetBoxes.forEach(box => {
                    box.classList.add('bg-red-300');
                    setTimeout(() => box.classList.remove('bg-red-300'), 500);
                });
                MessageBox.show("é †åºä¸æ­£ç¢ºï¼Œå†è©¦è©¦çœ‹ï¼", true);
            }
        }

        function renderGame5() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'game5') return;

            const targetBoxesHtml = state.g5_currentSort.map((char, index) => `
                <div class="w-16 h-16 bg-white target-box border-4 border-dashed border-gray-400 rounded-lg flex items-center justify-center text-3xl font-bold cursor-pointer hover:bg-gray-100 transition duration-150"
                     onclick="handleResetTargetG5(${index})">
                    ${char || ' '}
                </div>
            `).join('');

            const letterBlocksHtml = state.g5_letters.map(letter => `
                <button onclick="handleLetterClickG5('${letter.id}')"
                        class="w-16 h-16 bg-accent-yellow ${letter.isDropped ? 'opacity-30 cursor-default' : 'hover:bg-yellow-400 shadow-cute'} rounded-lg flex items-center justify-center text-3xl font-bold transition duration-200"
                        ${letter.isDropped ? 'disabled' : ''}>
                    ${letter.value}
                </button>
            `).join('');


            container.innerHTML = `
                <section class="w-full bg-secondary-blue p-4 rounded-xl shadow-inner border-b-8 border-blue-600">
                    <h2 class="text-xl md:text-3xl font-bold text-blue-800 mb-4 text-center">ğŸ‘‚ å­—æ¯é †åºæ’åº (Letter Order Sort)</h2>
                    <p class="text-center text-sm text-blue-900 mb-4">ç›®æ¨™: å°‡è½åˆ°çš„å­—æ¯æŒ‰å­—æ¯è¡¨é †åºæ’åˆ—ã€‚</p>
                    
                    <div class="text-center mb-6">
                        <button onclick="speakLettersG5()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-8 rounded-full shadow-cute text-xl flex items-center mx-auto">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a.75.75 0 011.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 011.06-1.06L12 12.44L15.536 8.464z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21a9 9 0 100-18 9 9 0 000 18z"></path></svg>
                            é»æ“Šå”¸å‡ºå­—æ¯ (é‡è¤‡ 3 æ¬¡)
                        </button>
                    </div>
                    
                    <div class="flex justify-center space-x-3 mb-8 p-4 bg-white rounded-xl shadow-inner border-4 border-gray-300">
                        ${targetBoxesHtml}
                    </div>

                    <div class="flex justify-center space-x-3 p-4 bg-keyboard-bg rounded-xl shadow-md border-4 border-accent-yellow">
                        ${letterBlocksHtml}
                    </div>
                    
                    <div class="text-center mt-6">
                        <button onclick="initGame5()" class="bg-primary-pink hover:bg-pink-400 text-white font-bold py-2 px-6 rounded-full shadow-cute text-lg">
                            é‡æ–°é–‹å§‹éŠæˆ²
                        </button>
                    </div>
                </section>
            `;
        }


        // --- å–®å­—ç®¡ç†å¾Œå° é‚è¼¯ ---
        async function addWord() {
            const { collection, addDoc } = window.firebaseImports;
            const input = document.getElementById('new-word-input');
            const word = input.value.trim().toUpperCase();

            // èª¿æ•´ï¼šå…è¨±å–®å­—åŒ…å«ç©ºæ ¼ (å¦‚ HOW OLD)ï¼Œä½†ä¸»è¦é‚„æ˜¯å­—æ¯
            if (!word || !/^[A-Z\s]+$/.test(word)) { 
                MessageBox.show("è«‹è¼¸å…¥æœ‰æ•ˆçš„è‹±æ–‡å­—æ¯å–®å­—æˆ–è©çµ„ã€‚");
                return;
            }

            if (!db || !userId) {
                MessageBox.show("ç³»çµ±å°šæœªåˆå§‹åŒ–ï¼Œè«‹ç¨å€™ã€‚");
                return;
            }

            const exists = wordList.some(item => item.word.toUpperCase() === word);
            if (exists) {
                MessageBox.show(`å–®å­— ${word} å·²ç¶“å­˜åœ¨æ–¼åˆ—è¡¨ä¸­ã€‚`);
                input.value = '';
                return;
            }

            try {
                const path = `artifacts/${appId}/users/${userId}/${FIREBASE_COLLECTION}`;
                await addDoc(collection(db, path), { word: word });
                input.value = '';
                MessageBox.show(`å–®å­— ${word} æ–°å¢æˆåŠŸï¼`, false);
            } catch (error) {
                console.error("Error adding document: ", error);
                MessageBox.show("æ–°å¢å–®å­—å¤±æ•—ï¼Œè«‹æª¢æŸ¥é€£ç·šã€‚", true);
            }
        }

        async function deleteWord(id) {
            const { doc, deleteDoc } = window.firebaseImports;
            if (!db || !userId) return;

            try {
                const path = `artifacts/${appId}/users/${userId}/${FIREBASE_COLLECTION}`;
                await deleteDoc(doc(db, path, id));
                MessageBox.show("å–®å­—åˆªé™¤æˆåŠŸï¼", false);
            } catch (error) {
                console.error("Error deleting document: ", error);
                MessageBox.show("åˆªé™¤å–®å­—å¤±æ•—ã€‚", true);
            }
        }

        function renderWordAdmin() {
            const container = document.getElementById('game-content');
            if (currentGame !== 'admin') return;

            const wordListHtml = wordList.map((item, index) => `
                <li class="flex justify-between items-center p-3 bg-white rounded-lg shadow-sm mb-2 border-l-4 border-primary-pink">
                    <span class="text-lg font-bold text-gray-800">${index + 1}. ${item.word}</span>
                    <button onclick="deleteWord('${item.id}')" class="text-red-500 hover:text-red-700 font-bold p-1 rounded-full bg-red-100 transition duration-150">
                        ğŸ—‘ï¸
                    </button>
                </li>
            `).join('');

            container.innerHTML = `
                <section class="w-full bg-primary-pink p-4 rounded-xl shadow-inner border-b-8 border-pink-600">
                    <h2 class="text-xl md:text-3xl font-bold text-white mb-2 text-center">âš™ï¸ å–®å­—ç®¡ç†å¾Œå° (Word Admin Panel)</h2>
                    <p class="text-center text-pink-100">è«‹æ³¨æ„: è³“æœéŠæˆ²å–®å­—ç‚ºå…§å»ºï¼Œæ­¤å–®å­—åº«åƒ…ä¾›ã€ŒçŒœå–®å­—ã€éŠæˆ²ä½¿ç”¨ã€‚</p>
                </section>

                <div class="p-6 bg-keyboard-bg rounded-xl shadow-md">
                    <label for="new-word-input" class="block text-lg font-semibold text-gray-800 mb-2">æ–°å¢å–®å­—/è©çµ„</label>
                    <div class="flex space-x-2">
                        <input type="text" id="new-word-input" placeholder="ä¾‹å¦‚ï¼šPIG" maxlength="15"
                               class="flex-1 p-3 border-2 border-gray-300 rounded-lg focus:ring-secondary-blue focus:border-secondary-blue uppercase">
                        <button onclick="addWord()" class="bg-secondary-blue hover:bg-blue-400 text-blue-900 font-bold py-3 px-6 rounded-lg shadow-cute transition duration-150">
                            â• æ–°å¢
                        </button>
                    </div>
                </div>

                <div class="p-6 bg-white rounded-xl shadow-md border-2 border-gray-200">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">ç›®å‰å–®å­—åˆ—è¡¨ (${wordList.length} å€‹)</h3>
                    <ul class="max-h-80 overflow-y-auto">
                        ${wordListHtml.length > 0 ? wordListHtml : '<p class="text-gray-500 text-center py-4">ç›®å‰æ²’æœ‰å–®å­—ã€‚è«‹æ–°å¢ï¼</p>'}
                    </ul>
                </div>
            `;
        }
    </script>
</body>
</html>
